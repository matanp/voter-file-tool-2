# 1.5b Audit Log Utility & Immutability Guard

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.5
**Effort:** 1–2 days
**Depends on:** [1.5a Audit Log Schema & SYSTEM User Seed](1.5a-audit-log-schema-and-seed.md)

## Summary

Create the `logAuditEvent` utility function and `SYSTEM_USER_ID` constant. Add Prisma middleware to enforce AuditLog immutability at runtime. Write unit tests for both the utility and the immutability guard.

## Acceptance Criteria

### Utility Function

- [ ] Create `apps/frontend/src/lib/auditLog.ts` exporting:

```ts
import { type AuditAction, type PrivilegeLevel } from "@prisma/client";

export const SYSTEM_USER_ID = "system";

export async function logAuditEvent(
  userId: string,
  userRole: PrivilegeLevel,
  action: AuditAction,
  entityType: string,
  entityId: string,
  before?: Record<string, unknown> | null,
  after?: Record<string, unknown> | null,
  metadata?: Record<string, unknown>,
): Promise<void>
```

- [ ] Implementation: single `prisma.auditLog.create(...)` call — no batch, no buffering
- [ ] **Non-throwing:** Wrap the `create` call in try/catch. On failure, `console.error` the error with context (action, entityType, entityId). Never throw — audit must never block the primary operation
- [ ] Export `SYSTEM_USER_ID = "system"` for callers performing system-initiated operations (e.g. scheduled jobs, migrations)
- [ ] `userRole` is passed by the caller (not resolved internally) — the caller has the session's `privilegeLevel` available from `withPrivilege`. This avoids an extra DB round-trip and captures the role at action-time

### Immutability Guard

- [ ] In the Prisma client setup (`apps/frontend/src/lib/prisma.ts`), add middleware that prevents `update` and `delete` operations on the `AuditLog` model:
  ```typescript
  prisma.$use(async (params, next) => {
    if (
      params.model === "AuditLog" &&
      (params.action === "update" ||
        params.action === "updateMany" ||
        params.action === "delete" ||
        params.action === "deleteMany")
    ) {
      throw new Error(
        `AuditLog is immutable: ${params.action} operations are not allowed`,
      );
    }
    return next(params);
  });
  ```
- [ ] This is a runtime safety net complementing the convention that `logAuditEvent` is the only write path

### Testing

- [ ] Unit tests in `apps/frontend/src/__tests__/lib/auditLog.test.ts`:
  - `logAuditEvent` creates an `AuditLog` record with correct fields (userId, userRole, action, entityType, entityId, timestamp, beforeValue, afterValue, metadata)
  - `logAuditEvent` with `before=null` and `after` populated (new entity creation)
  - `logAuditEvent` with both `before` and `after` populated (status transition)
  - `logAuditEvent` does not throw when `prisma.auditLog.create` rejects — logs to `console.error` instead
  - `SYSTEM_USER_ID` equals `"system"`

- [ ] Unit tests for immutability guard in `apps/frontend/src/__tests__/lib/auditLogImmutability.test.ts` (or same file):
  - `prisma.auditLog.update()` throws with immutability error message
  - `prisma.auditLog.delete()` throws with immutability error message
  - Other models (e.g. `prisma.user.update()`) are not affected by the middleware

### Test Patterns

- [ ] Follow existing test patterns: mock Prisma via `prismaMock` from `__tests__/utils/mocks.ts`
- [ ] Use `jest.spyOn(console, "error").mockImplementation()` to verify error logging without polluting test output

## Implementation Notes

- **Function signature:** `userRole` is a required parameter (not optional) because every audit event must record who performed the action and at what privilege level. The caller passes `session.user.privilegeLevel` (available in all `withPrivilege`-wrapped routes) or `PrivilegeLevel.Developer` for the SYSTEM user.
- **`before` / `after` values:** These are full-entity snapshots (or null for creation/deletion). The caller is responsible for constructing the snapshot. For most routes, this is the membership status and relevant fields before/after the DB operation.
- **Prisma middleware vs. `$extends`:** Prisma 5.x supports both `$use` (middleware) and `$extends` (client extensions). `$use` is simpler for this guard and already well-documented. If the project migrates to `$extends` later, the guard can be moved.
- **IP address capture:** Deferred. SRS §11.1 does not require IP logging. The `metadata` field is flexible enough to add it later (e.g. in ticket 2.1 for override logging or 3.5 for audit UI).

## Related

- [1.5 Audit Trail Infrastructure](1.5-audit-trail-infrastructure.md) — parent ticket
- [1.5a Audit Log Schema & SYSTEM User Seed](1.5a-audit-log-schema-and-seed.md) — prerequisite
- [1.5c Audit Log Route Wiring](1.5c-audit-log-route-wiring.md) — next step (consumes `logAuditEvent`)
- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2 — AuditLog model spec
