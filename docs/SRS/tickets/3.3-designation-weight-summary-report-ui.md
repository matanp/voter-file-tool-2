# 3.3 Designation Weight Summary Report UI

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.3
**Effort:** 2–4 days
**Depends on:** [2.7 Weight / Designation Logic](2.7-weight-designation-logic.md), [3.2 Sign-In Sheet Report UI](3.2-sign-in-sheet-report-ui.md)

## Summary

Add the Designation Weight Summary report — both the report-server renderer and the frontend UI. This report provides a committee-by-committee breakdown of seat weights, petitioned status, occupancy, and total designation weight. Useful for verifying weight calculations and for official county records.

## Current State

- **Weight engine** exists in two locations:
  - `apps/frontend/src/lib/designationWeight.ts` — `computeDesignationWeightFromData()` (pure function, used by API).
  - `apps/report-server/src/committeeMappingHelpers.ts` — `computeDesignationWeight()` and `fetchDesignationWeights()` (report-server version, lines 135–266). Returns `DesignationWeightSummary[]`.
- **Report-server types** already defined: `SeatWeightBreakdown`, `DesignationWeightSummary` with fields: `committeeListId`, `cityTown`, `legDistrict`, `electionDistrict`, `totalWeight`, `totalContributingSeats`, `seats[]`, `missingWeightSeatNumbers`.
- **Report pipeline** pattern established by 3.2 (Sign-In Sheet).

## Acceptance Criteria

### Report-Server — `designationWeightSummary` Report Type

#### Schema Registration
- [x] Add `designationWeightSummaryReportSchema` to `packages/shared-validators/src/schemas/report.ts`:
  ```ts
  const designationWeightSummaryReportSchema = z.object({
    type: z.literal('designationWeightSummary'),
    name: z.string(),
    format: z.enum(['pdf', 'xlsx']),  // both formats supported
    reportAuthor: z.string(),
    jobId: z.string().cuid(),
    scope: z.enum(['jurisdiction', 'countywide']),
    cityTown: z.string().optional(),
    legDistrict: z.number().optional(),
  });
  ```
- [x] Add to `generateReportSchema` discriminated union.
- [x] Add to `REPORT_TYPE_MAPPINGS`:
  ```ts
  designationWeightSummary: { databaseValue: 'DesignationWeightSummary', filename: 'designationWeightSummary' }
  ```

#### Data Fetching
- [x] Use existing `fetchDesignationWeights()` from `committeeMappingHelpers.ts` which already fetches all committees with seats + active memberships and computes weights.
- [x] Add optional scope filtering: if `scope=jurisdiction`, filter results by `cityTown` (and optional `legDistrict`) after computation.
- [x] Sort output by cityTown → legDistrict → electionDistrict.

#### PDF Component
- [x] Create `apps/report-server/src/components/DesignationWeightSummary.tsx`:
  - **Page layout**: Landscape 11"×8.5" (matching `CommitteeReport.tsx` pattern).
  - **Header**: "Designation Weight Summary — [scope description] — [generation date]".
  - **Table structure** — One section per cityTown/legDistrict group:
    - **Group header row**: "City/Town: [name], Legislative District: [number]"
    - **Column headers**: ED, Total Seats, Petitioned Seats, Occupied Petitioned, Vacant Petitioned, Appointed, LTED Weight, Designation Weight, Missing Weights
    - **Data rows**: One per committee (election district).
    - **Group subtotal row**: Sum of designation weights for the LD.
  - **Grand total row**: Sum of all designation weights.
  - **Footnotes**: "— indicates weight data not available for one or more seats", list of committees with `missingWeightSeatNumbers`.
  - **Pagination**: Page break between groups if needed; max ~20 rows per page.

#### XLSX Output
- [x] Add `designationWeightSummary` path to XLSX generation:
  - **Single worksheet**: "Weight Summary"
  - **Columns**: City/Town, Leg District, Election District, Total Seats, Petitioned Seats, Occupied Petitioned, Vacant Petitioned, Appointed, LTED Weight, Designation Weight, Notes (missing weights)
  - **Subtotal rows** per LD group, **grand total** at bottom.
  - Use existing `xlsxUtils.ts` patterns (`createWorkbook`, `createWorksheet`, `uploadXLSXBuffer`).

#### Handler
- [x] Add `designationWeightSummary` case to `processJob()` in `index.ts`.

### Frontend — Report UI

#### Report Picker
- [x] Update `GenerateReportGrid.tsx`: Enable "Designation Weight Summary" card.
  - Description: "Committee-by-committee breakdown of seat weights, occupancy, and total designation weight."

#### Report Form Page
- [x] Create `apps/frontend/src/app/weight-summary-reports/page.tsx` and `WeightSummaryForm.tsx`.
- [x] Form fields (follow pattern from 3.2):
  - **Report name** — Text input with default "Weight Summary - [date]".
  - **Format** — Dropdown: PDF / XLSX. Default: XLSX.
  - **Scope** — Radio: "My Jurisdictions" / "Countywide". Leader restricted to jurisdictions only.
  - **Jurisdiction filter** — cityTown + optional legDistrict (when scope=jurisdiction).
- [x] Validation: If scope=jurisdiction, cityTown is required.
- [x] After submission, show `ReportStatusTracker`.

#### API Route
- [x] Update `/api/generateReport` to accept `type: 'designationWeightSummary'`.
- [x] Apply jurisdiction scoping for Leaders.

### Report Parameter Matrix Entry

| Parameter | Required? | Default | Leader | Admin |
|-----------|-----------|---------|--------|-------|
| name | Yes | "Weight Summary - [date]" | Yes | Yes |
| format | Yes | xlsx | Yes | Yes |
| scope | Yes | jurisdiction (leader) / countywide (admin) | jurisdiction only | both |
| cityTown | If scope=jurisdiction | — | From jurisdictions | All cities |
| legDistrict | No | All | From jurisdictions | All |

### Labeling Standard
- [x] Report picker card title: **"Designation Weight Summary"**
- [x] Generated report list display: **"Designation Weight Summary"**
- [x] Status messages: "Generating designation weight summary..." / "Designation weight summary ready"
- [x] Update `formatReportType()` in `reportUtils.ts`.

### Testing
- [x] Report-server: Test `fetchDesignationWeights()` with scope filtering.
- [x] Report-server: Test PDF component renders correct table structure with groups, subtotals, grand total.
- [x] Report-server: Test XLSX output has correct columns and calculations.
- [x] Report-server: Test handling of committees with `missingWeightSeatNumbers`.
- [x] Frontend: Test form validation and scope restrictions.

## Implementation Steps

1. **Schema** — Add report schema and type mapping.
2. **PDF component** — Create `DesignationWeightSummary.tsx`.
3. **XLSX generation** — Add weight summary XLSX logic.
4. **Handler** — Add case to `processJob()`.
5. **Frontend** — Create form page and enable report picker card.
6. **API** — Update generateReport handler.
7. **Tests**.

## Files to Create

| File | Purpose |
|------|---------|
| `apps/report-server/src/components/DesignationWeightSummary.tsx` | PDF React component |
| `apps/frontend/src/app/weight-summary-reports/page.tsx` | Report page |
| `apps/frontend/src/app/weight-summary-reports/WeightSummaryForm.tsx` | Form component |

## Files to Modify

| File | Change |
|------|--------|
| `packages/shared-validators/src/schemas/report.ts` | Add schema + union member |
| `packages/shared-validators/src/reportTypeMapping.ts` | Add mapping |
| `apps/report-server/src/index.ts` | Add handler |
| `apps/report-server/src/committeeMappingHelpers.ts` | Add scope filtering to `fetchDesignationWeights()` |
| `apps/frontend/src/components/reports/GenerateReportGrid.tsx` | Enable card |
| `apps/frontend/src/components/reports/reportUtils.ts` | Add to `formatReportType()` |

## Related

- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §13
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.3
- [2.7 Weight / Designation Logic](2.7-weight-designation-logic.md)
- [3.2 Sign-In Sheet Report UI](3.2-sign-in-sheet-report-ui.md)
