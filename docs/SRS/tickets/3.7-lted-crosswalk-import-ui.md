# 3.7 LTED Crosswalk Import UI/Admin Flow

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Tier 3 follow-up
**Effort:** 0.5–1 day
**Depends on:** [1.1b LTED-to-Assembly-District Mapping](1.1b-lted-assembly-district-mapping.md), [3.1 Jurisdiction Assignment UI](3.1-jurisdiction-assignment-ui.md)

## Summary

Implement the admin UX for importing/updating the LTED-to-district crosswalk mapping. The `LtedDistrictCrosswalk` model and seed script already exist from ticket 1.1b. This ticket adds a UI-based import flow so admins can update mappings without running CLI commands.

## Current State

- **Model** — `LtedDistrictCrosswalk` exists in `apps/frontend/prisma/schema.prisma` (lines 519–530):
  - Fields: `cityTown`, `legDistrict`, `electionDistrict`, `stateAssemblyDistrict`, `stateSenateDistrict?`, `congressionalDistrict?`, `countyLegDistrict?`.
  - **No `createdAt`/`updatedAt`** — the table has no timestamp columns; “last imported” must come from elsewhere (see design decision below).
  - Unique: `@@unique([cityTown, legDistrict, electionDistrict])`.
- **CLI seed** — `pnpm --filter voter-file-tool db:seed-lted-crosswalk [path/to/2024 LTED Matrix.xlsx]` reads the `NEW_LTED_Matrix` sheet and upserts rows.
- **Weighted table import** — A similar admin import flow exists at `apps/frontend/src/app/api/admin/weightedTable/import/route.ts` which parses MCDC Excel files and updates `CommitteeList.ltedWeight`. This is the closest existing pattern to follow.
- **Admin Data page** — `/admin/data` uses a tab-based interface (`AdminDataClient.tsx`) with 6 tabs. The crosswalk import could be a new tab.
- **Eligibility integration** — `apps/frontend/src/lib/eligibility.ts` (lines 148–179) uses the crosswalk for AD matching when `requireAssemblyDistrictMatch=true`.

## Design Decision: “Last imported” timestamp

**Decision: Use audit log (no schema change to `LtedDistrictCrosswalk`).**

- **Problem**: The spec called for “last imported” via the most recent crosswalk record’s `updatedAt`, but `LtedDistrictCrosswalk` has no `createdAt` or `updatedAt`.
- **Chosen approach**: Define “last imported” as the timestamp of the most recent **bulk import** event in the audit log:
  - On bulk import (`POST /api/admin/crosswalk/import`), log an audit entry with a dedicated action (e.g. add `CROSSWALK_IMPORTED` to `AuditAction`) or with `DISCREPANCY_RESOLVED` and `metadata.importType === "crosswalk"`.
  - The UI queries: most recent `AuditLog` row with that action (and metadata if using `DISCREPANCY_RESOLVED`), and displays its `timestamp` as “Last imported”.
- **Justification**:
  1. **Semantics**: "Last imported" should mean "last time a **bulk import** was run," not "last time any crosswalk row was updated." If we used `max(updatedAt)` on the table, a single manual edit would change "last imported," which is misleading. The audit log records the import *event*; the table only records current state.
  2. **Single source of truth**: We already commit to writing an audit entry on bulk import. Using that entry for the timestamp avoids a second place to maintain (e.g. a "last import" metadata row or column) and keeps "who ran the import" and "when" in one place.
  3. **No schema churn**: Adding `createdAt`/`updatedAt` to `LtedDistrictCrosswalk` would require a migration and a backfill (or nullable timestamps). Audit is already present and indexed by `action` and `timestamp`; no schema change.
  4. **CLI seed**: The CLI seed script does not write audit entries today. "Last imported" in the UI will therefore reflect only *admin UI* imports until/unless we add audit logging to the CLI; that's acceptable and can be documented. Putting "last imported" on the table would still not help for CLI (we'd have to set timestamps in the seed), so audit is not worse on that axis.
- **Alternative (deferred)**: Add a migration for `createdAt`/`updatedAt` on `LtedDistrictCrosswalk` and use `max(updatedAt)` if we later want “last modified (any change)” on the table; not required for this ticket.

## Design Decision: Input Mode

**Decision: Excel upload (primary) + manual single-row fallback.**

- **Primary**: Excel file upload matching the LTED Matrix format (same format as the CLI seed script). This is the format admins receive from MCDC.
- **Fallback**: Manual entry form for adding/editing individual crosswalk rows (for corrections or small updates between full imports).
- **Rationale**: The CLI seed script already handles Excel parsing. The admin UI wraps this in a web flow. Manual entry handles edge cases without requiring a full re-import.

## Acceptance Criteria

### API Routes

#### Bulk Import
- [ ] `POST /api/admin/crosswalk/import` — Upload Excel file and upsert crosswalk rows.
  - **Input**: FormData with Excel file (`.xlsx`).
  - **Processing** (follow pattern from `weightedTable/import/route.ts`):
    1. Parse Excel file using the same library (e.g., `xlsx` / `exceljs`).
    2. Read `NEW_LTED_Matrix` sheet (or accept configurable sheet name).
    3. For each row, extract: town code → cityTown (using `TOWN_CODE_TO_CITY` map), ward → legDistrict, district → electionDistrict, plus assembly/senate/congressional/county-leg district columns.
    4. Validate: cityTown is recognized, legDistrict and electionDistrict are numbers, at least `stateAssemblyDistrict` is present.
    5. Upsert into `LtedDistrictCrosswalk` (match on unique key: cityTown + legDistrict + electionDistrict).
  - **Response**:
    ```ts
    {
      success: true,
      summary: {
        rowsProcessed: number,
        created: number,
        updated: number,
        skipped: number,      // rows with validation errors
        errors: { row: number, message: string }[],  // row-level errors (max 50)
      }
    }
    ```
  - Admin only.
  - Audit log: Add `CROSSWALK_IMPORTED` to `AuditAction` and log one entry per bulk import (entityType e.g. `"LtedDistrictCrosswalk"`, entityId optional or summary id); this drives the “Last imported” display. Alternatively reuse `DISCREPANCY_RESOLVED` with `metadata.importType === "crosswalk"` and query by action + metadata.

#### Manual Entry/Edit
- [ ] `POST /api/admin/crosswalk` — Create or update a single crosswalk row.
  - Body:
    ```ts
    {
      cityTown: string,
      legDistrict: number,
      electionDistrict: number,
      stateAssemblyDistrict: string,
      stateSenateDistrict?: string,
      congressionalDistrict?: string,
      countyLegDistrict?: string,
    }
    ```
  - Upsert on unique key. Return the created/updated record.
  - Admin only.

#### List/View
- [ ] `GET /api/admin/crosswalk` — List all crosswalk entries with optional filters.
  - Query params: `cityTown` (optional), `legDistrict` (optional), `page`, `pageSize`.
  - Response: Paginated list of `LtedDistrictCrosswalk` records.
  - Admin only.

#### Delete
- [ ] `DELETE /api/admin/crosswalk/[id]` — Delete a single crosswalk entry.
  - Admin only. Audit logged.
  - Confirm: If this LTED is used in eligibility checks (`requireAssemblyDistrictMatch=true`), show warning.

### Admin UI

#### Entry Point
- [ ] Add "LTED Crosswalk" as a new tab in `/admin/data` (`AdminDataClient.tsx`).
  - Tab label: "LTED Crosswalk"
  - Position: After "Weighted Table" tab (they are related data management tasks).

#### Crosswalk Tab Component
- [ ] Create `apps/frontend/src/app/admin/data/LtedCrosswalkTab.tsx`:
  - **Two sections**: Import (top) and Browse/Edit (bottom).

#### Import Section
- [ ] File upload area:
  - Drag-and-drop zone or file input accepting `.xlsx` files.
  - "Upload LTED Matrix" button.
  - Follow the pattern from `WeightedTableImport` component (same admin data page).
- [ ] On upload:
  - Show loading spinner.
  - Display import summary card when complete:
    - "X rows processed, Y created, Z updated, W skipped"
    - If errors: expandable error list showing row number + error message.
  - Success/error toast notification.
- [ ] "Last imported" timestamp display: query the most recent audit log entry for the crosswalk bulk-import action (`CROSSWALK_IMPORTED` or `DISCREPANCY_RESOLVED` with crosswalk metadata) and show its `timestamp`; show “Never” (or hide the line) if none exists.

#### Browse/Edit Section
- [ ] **Crosswalk table** — Paginated table showing current crosswalk entries.
  - Columns: City/Town, Leg District, Election District, Assembly District, Senate District, Congressional District, County Leg District, Actions.
  - Filters: cityTown dropdown, legDistrict input.
  - Pagination: 25 rows per page.
- [ ] **Edit** — Click a row to open inline edit or a small modal with pre-filled fields. Save updates via `POST /api/admin/crosswalk`.
- [ ] **Add** — "Add Row" button opens the same form empty. For manual corrections.
- [ ] **Delete** — Delete button per row with confirmation dialog. Shows warning if `requireAssemblyDistrictMatch` is enabled.

### Operator Guidance
- [ ] Add a help text block at the top of the tab:
  - "The LTED Crosswalk maps committee jurisdictions (City/Town, Leg District, Election District) to state legislative districts. This data is used for assembly district eligibility validation."
  - "Upload the LTED Matrix Excel file from MCDC when updated (typically at the start of each new term)."
  - "Use manual entry for individual corrections between full imports."
- [ ] Document update cadence in the checklist doc or inline: "Import at start of each term; update if redistricting occurs mid-term."

### Testing
- [ ] API: Test bulk import with valid Excel file → correct create/update counts.
- [ ] API: Test bulk import with invalid rows → skipped with error messages.
- [ ] API: Test manual create/update via POST.
- [ ] API: Test duplicate handling (upsert on unique key).
- [ ] API: Test list endpoint with pagination and filters.
- [ ] API: Test delete endpoint.
- [ ] UI: Test file upload flow → summary display.
- [ ] UI: Test error display for invalid rows.
- [ ] UI: Test browse table with pagination.
- [ ] UI: Test manual add/edit form.

## Implementation Steps

1. **API routes** — Create import, CRUD, and list endpoints for crosswalk.
2. **Excel parsing** — Port logic from the CLI seed script into the import route (or extract shared parsing function).
3. **UI tab** — Add "LTED Crosswalk" tab to AdminDataClient.tsx.
4. **Import UI** — Build file upload + summary display component.
5. **Browse/Edit UI** — Build crosswalk table with inline edit and add form.
6. **Help text** — Add operator guidance copy.
7. **Tests**.

## Files to Create

| File | Purpose |
|------|---------|
| `apps/frontend/src/app/admin/data/LtedCrosswalkTab.tsx` | Crosswalk tab component |
| `apps/frontend/src/app/api/admin/crosswalk/route.ts` | POST (manual entry) + GET (list) |
| `apps/frontend/src/app/api/admin/crosswalk/[id]/route.ts` | DELETE |
| `apps/frontend/src/app/api/admin/crosswalk/import/route.ts` | POST (Excel bulk import) |

## Files to Modify

| File | Change |
|------|--------|
| `apps/frontend/src/app/admin/data/AdminDataClient.tsx` | Add "LTED Crosswalk" tab |

## Related

- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §9
- [SRS_GAPS_AND_CONSIDERATIONS.md](../SRS_GAPS_AND_CONSIDERATIONS.md) §2.1
- [1.1b LTED-to-Assembly-District Mapping](1.1b-lted-assembly-district-mapping.md)
- [3.1 Jurisdiction Assignment UI](3.1-jurisdiction-assignment-ui.md)
