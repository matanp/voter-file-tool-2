# 2.6 Petition + Primary Outcome Tracking

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.6
**Effort:** 5–8 days
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md), [1.3 Membership Type](1.3-membership-type.md), [1.4 Seat Model](1.4-seat-model.md), [2.4 Meeting Workflow](2.4-meeting-record-confirmation-workflow.md)

## Summary

Implement petition outcome recording so the system can represent challengers, vote results, winners/losers/ties, and petitioned seat status. Use `CommitteeMembership` as the canonical record for challengers and outcomes (no separate `PetitionRecord` model in v1).

## Acceptance Criteria

### Data Model (v1 approach)

- [x] Reuse `CommitteeMembership` for petition candidates and outcomes.
- [x] Add `petitionSeatNumber Int?` to `CommitteeMembership` to tie a candidate/outcome to a specific seat.
- [x] Keep existing petition fields:
  - `petitionVoteCount`
  - `petitionPrimaryDate`
- [x] Add index for petition lookups:

```prisma
@@index([committeeListId, termId, petitionSeatNumber])
```

### Outcome Semantics

- [x] Each petition workflow operation is scoped to one `(committeeListId, termId, seatNumber)`.
- [x] Candidate rows for that seat are represented by `CommitteeMembership` records with:
  - `membershipType = PETITIONED`
  - `petitionSeatNumber = seatNumber`

- [x] Outcome mapping:
  - Winner: `status = ACTIVE`, `seatNumber = seatNumber`, `activatedAt=now`
  - Loser: `status = PETITIONED_LOST`, `seatNumber = null`
  - Tie: `status = PETITIONED_TIE`, `seatNumber = null`
  - Unopposed winner: `status = ACTIVE`, winner only

- [x] Seat mutation:
  - Set `Seat.isPetitioned = true` for `seatNumber` when first petition outcome is recorded.
  - Once set true for the term, it is immutable.

### API

- [x] Create `POST /api/admin/petition-outcomes/record` (Admin-only):

```ts
{
  committeeListId: number;
  termId?: string; // defaults to active term
  seatNumber: number;
  primaryDate: string; // ISO date
  candidates: Array<{
    voterRecordId: string;
    voteCount?: number;
    outcome: "WON_PRIMARY" | "LOST_PRIMARY" | "TIE" | "UNOPPOSED";
  }>;
}
```

- [x] Validation rules:
  - Exactly one winner (`WON_PRIMARY` or `UNOPPOSED`) unless tie-only scenario.
  - At least one candidate.
  - Candidate IDs are unique in payload.
  - `seatNumber` must exist in `Seat` table for committee+term.

- [x] API behavior:
  - Upsert candidate membership rows by `(voterRecordId, committeeListId, termId)`.
  - Persist primary metadata on each candidate row (`petitionPrimaryDate`, `petitionVoteCount`).
  - Apply status transitions listed above.
  - For winning activation, ensure seat availability consistency.

- [x] Create `GET /api/admin/petition-outcomes` (Admin-only):
  - Filter by term, committee, outcome status.
  - Returns seat-level outcome history.

### UI

- [x] Enable `/admin/petition-outcomes` in `apps/frontend/src/config/adminNav.ts`.
- [x] Add page and components:
  - `apps/frontend/src/app/admin/petition-outcomes/page.tsx`
  - `apps/frontend/src/app/admin/petition-outcomes/PetitionOutcomesClient.tsx`
  - `apps/frontend/src/app/admin/petition-outcomes/CandidateOutcomeTable.tsx`
- [x] UX flow:
  - Select committee + seat.
  - Add/select challengers.
  - Enter primary date + vote counts + outcome per challenger.
  - Submit with confirmation summary.

### Audit Logging

- [x] Log `PETITION_RECORDED` once per submission payload with metadata:
  - `committeeListId`, `termId`, `seatNumber`, candidate outcomes summary.
- [x] For winner activation/loser transitions, keep membership transition audit events (`MEMBER_ACTIVATED`, etc.) consistent with status changes.

### Tests

- [x] API tests for outcome validation:
  - reject invalid winner counts
  - reject duplicate candidate IDs
  - reject unknown seatNumber
- [x] API tests for status transitions:
  - winner -> `ACTIVE` with seat assignment
  - loser -> `PETITIONED_LOST`
  - tie -> `PETITIONED_TIE`
  - unopposed -> `ACTIVE`
- [x] Test that `Seat.isPetitioned` flips once and cannot be reset.

## Implementation Notes

- **Why membership-centric:** existing schema already models petition lifecycle statuses; this avoids duplicating state across two models.
- **Seat ownership:** petition outcomes are tracked per seat; this is required for 2.7 weight calculations.
- **Current petitions page:** `/petitions` remains report/form generation; this ticket introduces a distinct admin outcome workflow at `/admin/petition-outcomes`.

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.6, §6.3
- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §5
- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1 (`MembershipStatus`, `MembershipType`)
- [1.3 Membership Type](1.3-membership-type.md)
- [1.4 Seat Model](1.4-seat-model.md)
- [2.7 Weight / Designation Logic](2.7-weight-designation-logic.md)
