# 3.1 Jurisdiction Assignment UI (Leader Access)

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.1
**Effort:** 3–5 days
**Depends on:** [1.1 Committee Term Model](1.1-committee-term-model.md), [IA-01 Admin IA v1 spec](IA-01-admin-ia-v1-spec.md)

## Summary

Implement the admin UX for assigning jurisdiction scope to leaders, the `UserJurisdiction` data model, jurisdiction-scoped API middleware, and the user-facing empty states when no scope exists.

## Current State (Implemented)

- **`UserJurisdiction` model** exists in schema with migrations. Leader access is scoped via `getUserJurisdictions()`.
- **`/admin/users`** is enabled in `adminNav.ts`. Page and `UsersClient.tsx` provide user list and jurisdiction add/remove.
- **`Leader` privilege level** exists in `PrivilegeLevel` enum.
- **CommitteeSelector** filters `committeeLists` by leader jurisdictions (server-side in `committees/page.tsx`). Empty states for no jurisdictions / jurisdictions with no committees. Fetches `/api/user/jurisdictions` for Leader.

## Acceptance Criteria

### Data Model — `UserJurisdiction`
- [x] Create new Prisma model `UserJurisdiction`:
  ```prisma
  model UserJurisdiction {
    id          String        @id @default(cuid())
    userId      String
    user        User          @relation(fields: [userId], references: [id])
    cityTown    String
    legDistrict Int?          // null means all leg districts in cityTown
    termId      String
    term        CommitteeTerm @relation(fields: [termId], references: [id])
    createdAt   DateTime      @default(now())
    createdById String        // admin who assigned
    createdBy   User          @relation("AssignedJurisdictions", fields: [createdById], references: [id])

    @@unique([userId, cityTown, legDistrict, termId])
    @@index([userId, termId])
    @@index([termId])
    @@index([createdById])
  }
  ```
- [x] Add `jurisdictions UserJurisdiction[]` relation to `User` model.
- [x] Add `assignedJurisdictions UserJurisdiction[]` relation to `User` (reverse of `createdBy`).
- [x] Add `userJurisdictions UserJurisdiction[]` relation to `CommitteeTerm` model.
- [x] Create and run Prisma migration.

**Design decision — `createdById` vs `createdBy` (String):** Use `createdById` with a relation to `User` (as in `MeetingRecord` and `CommitteeMembership.submittedBy`). This gives referential integrity, allows "who assigned" in the admin UI via `include: { createdBy: { select: { name: true, email: true } } }`, and aligns with the codebase audit recommendation to avoid bare `createdBy` strings (see `Invite.createdBy` in CODE_REVIEW_RECOMMENDATIONS.md §19). Optional: set `onDelete: SetNull` and make `createdById` optional if admin deletion should not block jurisdiction records; otherwise keep required with default `Restrict`.

### API — Jurisdiction CRUD
- [x] `POST /api/admin/jurisdictions` — Assign jurisdiction to user.
  - Body: `{ userId: string, cityTown: string, legDistrict?: number, termId: string }`
  - Validation: user exists and has Leader privilege; term exists; no duplicate assignment.
  - Response: `{ success: true, jurisdiction: UserJurisdiction }` or `400` with error.
  - Audit: log `JURISDICTION_ASSIGNED` (action already in `AuditAction` enum).
- [x] `DELETE /api/admin/jurisdictions/[id]` — Remove jurisdiction assignment.
  - Admin only. Audit log the removal.
- [x] `GET /api/admin/jurisdictions?userId=X&termId=Y` — List jurisdictions for a user/term.
  - Admin only. Returns `UserJurisdiction[]` with user and term details.
- [x] `GET /api/user/jurisdictions` — Leader fetches own jurisdictions for active term.
  - Returns `UserJurisdiction[]` filtered to `session.user.id` and active term.

### API — Jurisdiction Middleware
- [x] Create `getUserJurisdictions(userId: string, termId: string)` helper in `apps/frontend/src/app/api/lib/committeeValidation.ts`.
  - Returns `UserJurisdiction[]` for the user+term.
  - If user is Admin/Developer, returns `null` (no scope restriction).
  - If user is Leader, returns their assigned jurisdictions.
- [x] Apply jurisdiction filter to existing endpoints:
  - `GET /api/fetchCommitteeList` — Leader can only fetch committees matching their jurisdictions.
  - `POST /api/committee/requestAdd` — Leader can only submit to committees in their jurisdictions.
  - `GET /api/committee/designationWeight` — Uses `getUserJurisdictions()`.

### Admin UI — `/admin/users` Page
- [x] Enable the "Users" nav item in `apps/frontend/src/config/adminNav.ts` (`enabled: true`).
- [x] Create page at `apps/frontend/src/app/admin/users/page.tsx`:
  - Server component that checks Admin privilege via `AuthCheck`.
- [x] Create client component `apps/frontend/src/app/admin/users/UsersClient.tsx`:
  - **User list** — Table of users with Leader+ privilege. Columns: Name, Email, Role, Jurisdiction Count, Actions.
  - **User detail / jurisdiction panel** — Expanding row or side panel showing:
    - Current jurisdictions for the active term (table: cityTown, legDistrict, assigned date).
    - "Add Jurisdiction" form: cityTown `ComboboxDropdown` (populated from distinct `CommitteeList.cityTown` values for active term), optional legDistrict `ComboboxDropdown` (populated when cityTown is selected, like CommitteeSelector), termId auto-set to active term.
    - Remove button per jurisdiction row (with confirmation).
  - **Duplicate prevention** — "Add Jurisdiction" button disabled if the combination already exists; show inline message.
- [x] Follow existing admin layout pattern from `apps/frontend/src/app/admin/layout.tsx` (sidebar + content area).
- [x] Use existing UI components: `ComboboxDropdown` for selectors, `Card`/`CardHeader`/`CardContent` for layout, `Dialog` for confirmation.

### Leader UI — CommitteeSelector Jurisdiction Filtering
- [x] Modify `CommitteeSelector.tsx` to filter `committeeLists` prop by the leader's jurisdictions:
  - On mount, fetch `/api/user/jurisdictions` to get the leader's assigned cityTown/legDistrict pairs.
  - Filter the city dropdown to only show assigned cities.
  - Filter the legDistrict dropdown to only show assigned districts (or all if `legDistrict` is null in the assignment).
- [x] **Empty state — No jurisdictions assigned:**
  - When a Leader user has zero `UserJurisdiction` records for the active term.
  - Display: Card with message "No jurisdictions assigned. Contact an administrator to get committee access."
  - Replaces the city/district selectors entirely.
- [x] **Empty state — Jurisdictions assigned but no committees:**
  - When a Leader's assigned jurisdictions match zero `CommitteeList` records.
  - Display: Card with message "No committees found in your assigned jurisdictions for the current term."
  - Show the assigned jurisdictions for context.

### Invite/User Management Flow
- [x] Decision: Jurisdiction assignment happens **post-invite** (not at invite time).
  - Rationale: Invites are managed in `/admin/data` (InviteManagement tab) and don't have jurisdiction context. Admin assigns jurisdictions after the user accepts the invite and is created.
  - **Implemented:** No changes to Invite model or invite API. Admins assign jurisdictions in Admin > Users after the user exists.
- [x] After a user accepts an invite with Leader role, they see the "No jurisdictions" empty state until an admin assigns scope.

### Testing
- [x] Unit tests for `UserJurisdiction` CRUD API routes (create, delete, list, duplicate prevention).
- [x] Unit test for `getUserJurisdictions()` helper — returns null for Admin, returns assignments for Leader.
- [x] Integration test: Leader with jurisdiction can fetch committee, Leader without cannot.
- [x] Integration test: Leader sees filtered city/district dropdowns matching their jurisdictions.
- [x] Test empty states render correctly for both scenarios.
- [x] Test audit logging for `JURISDICTION_ASSIGNED`.

## Implementation Steps

1. **Schema** — Add `UserJurisdiction` model to `prisma/schema.prisma`, add relations, run migration.
2. **API helpers** — Create `getUserJurisdictions()` in `committeeValidation.ts`.
3. **CRUD routes** — Implement `/api/admin/jurisdictions` POST, DELETE, GET and `/api/user/jurisdictions` GET.
4. **Admin UI** — Enable nav item, create `/admin/users` page with user list and jurisdiction management.
5. **Leader filtering** — Update `CommitteeSelector.tsx` to use jurisdiction data for filtering.
6. **Empty states** — Add two distinct empty state components/messages.
7. **Scope enforcement** — Apply `getUserJurisdictions()` filter to `fetchLoaded`, `requestAdd`, `designationWeight`.
8. **Tests** — API route tests, helper tests, component render tests.

## Files to Create

| File | Purpose |
|------|---------|
| `apps/frontend/src/app/admin/users/page.tsx` | Admin users page (server component) |
| `apps/frontend/src/app/admin/users/UsersClient.tsx` | Admin users client component |
| `apps/frontend/src/app/api/admin/jurisdictions/route.ts` | POST + GET jurisdictions |
| `apps/frontend/src/app/api/admin/jurisdictions/[id]/route.ts` | DELETE jurisdiction |
| `apps/frontend/src/app/api/user/jurisdictions/route.ts` | Leader's own jurisdictions |

## Files to Modify

| File | Change |
|------|--------|
| `apps/frontend/prisma/schema.prisma` | Add `UserJurisdiction` model + relations |
| `apps/frontend/src/config/adminNav.ts` | Enable "Users" nav item |
| `apps/frontend/src/app/committees/CommitteeSelector.tsx` | Add jurisdiction filtering + empty states |
| `apps/frontend/src/app/api/lib/committeeValidation.ts` | Add `getUserJurisdictions()` helper |
| `apps/frontend/src/app/api/committee/fetchLoaded/route.ts` | Apply jurisdiction scope |
| `apps/frontend/src/app/api/committee/requestAdd/route.ts` | Apply jurisdiction scope |
| `apps/frontend/src/app/api/committee/designationWeight/route.ts` | Replace ad-hoc scope with `getUserJurisdictions()` |

## Related

- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §8, §12
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.1
- [IA-01 Admin IA v1 Spec](IA-01-admin-ia-v1-spec.md)
