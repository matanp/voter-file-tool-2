# 1.R.21 High-Risk Route Test Coverage (P2)

**Status:** Done
**Priority:** P2 — Medium
**Effort:** 0.5–1 day
**Depends on:** [1.R.20 Admin Flow Audit Coverage](1.R.20-admin-flow-audit-coverage.md), [1.4 Seat Model](1.4-seat-model.md)

## Summary

Close the remaining Phase 1 code-review test gap by adding route-level coverage for weighted-table import and cross-committee safety constraints.

## Acceptance Criteria

- [x] Add route tests for `/api/admin/weightedTable/import` covering:
  - ambiguous LTED rows are skipped/rejected deterministically.
  - full-key (city/town + LD + ED + term) targeting updates exactly one committee.
- [x] Add negative-path tests for discrepancy acceptance rejecting voters already active in another committee.
- [x] Add tests for bulk import duplicate assignments across committees in the same term resulting in discrepancy handling (not dual ACTIVE memberships).
- [x] Add at least one regression test proving single-active-membership invariant is preserved after admin bulk/discrepancy workflows.

## Implementation Notes

- **Test files (implemented):**
  - `apps/frontend/src/__tests__/api/admin/weightedTableImport.test.ts` — ambiguous LTED skip (no resolver + matrix-ambiguous), full-key via crosswalk, full-key via matrix.
  - `apps/frontend/src/__tests__/api/admin/handleCommitteeDiscrepancy.test.ts` — 400 when voter ACTIVE in another committee; single-active-membership invariant regression.
  - `apps/frontend/src/__tests__/api/admin/bulkLoadCommittees.bulkLoadUtils.test.ts` — duplicate assignments → discrepancies only (no dual ACTIVE); single-active-membership invariant regression.

## Related

- [PHASE1_CODE_REVIEW_FINDINGS.md](../PHASE1_CODE_REVIEW_FINDINGS.md) (Finding 6)
- [T1.3 Discrepancy Handling Tests](T1.3-discrepancy-handling-tests.md)
