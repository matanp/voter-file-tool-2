# 1.5 Audit Trail Infrastructure

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.5
**Effort:** 3–5 days
**Depends on:** Nothing (run last in Tier 1 so all models are stable before wiring)

## Summary

Introduce the `AuditLog` model and `AuditAction` enum as an immutable record of all system changes. Provide a utility function for logging events and wire it into all existing mutation routes. Admin UI for viewing the audit log is deferred to ticket 3.5.

## Acceptance Criteria

### Schema

- [ ] New `AuditAction` enum per [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1:
  `MEMBER_SUBMITTED`, `MEMBER_REJECTED`, `MEMBER_CONFIRMED`, `MEMBER_ACTIVATED`, `MEMBER_RESIGNED`, `MEMBER_REMOVED`, `PETITION_RECORDED`, `MEETING_CREATED`, `REPORT_GENERATED`, `TERM_CREATED`, `JURISDICTION_ASSIGNED`, `DISCREPANCY_RESOLVED`
- [ ] New `AuditLog` model per [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2:
  - `id String @id @default(cuid())`
  - `userId String` + `user User @relation("AuditLogs", ...)`
  - `userRole PrivilegeLevel`
  - `action AuditAction`
  - `entityType String` — e.g. `"CommitteeMembership"`, `"MeetingRecord"`
  - `entityId String` — ID of the affected record
  - `timestamp DateTime @default(now())`
  - `beforeValue Json?` — snapshot before change
  - `afterValue Json?` — snapshot after change
  - `metadata Json?` — additional context (IP, override reason, bypass notes, etc.)
  - `@@index([entityType, entityId])`, `@@index([userId])`, `@@index([timestamp])`, `@@index([action])`
- [ ] Add `auditLogs AuditLog[] @relation("AuditLogs")` to `User` model (if not already added in 1.2)
- [ ] **Immutability:** no Prisma `update` or `delete` operations on `AuditLog` anywhere in the codebase — records are write-once
- [ ] **SYSTEM user seed:** add a `User` record with a fixed well-known `id: "system"` and placeholder email `system@internal` in `apps/frontend/prisma/seed.ts` (re-entrant: `upsert` with `where: { id: "system" }`). Required because `AuditLog.userId` is a non-nullable FK — a bare string sentinel would violate referential integrity

### Utility Function

- [ ] Create `apps/frontend/src/lib/auditLog.ts` exporting:

```ts
logAuditEvent(
  userId: string,
  action: AuditAction,
  entityType: string,
  entityId: string,
  before?: Record<string, unknown>,
  after?: Record<string, unknown>,
  metadata?: Record<string, unknown>
): Promise<void>
```

- [ ] Implementation: single `prisma.auditLog.create(...)` call — no batch, no buffering
- [ ] Export a constant `SYSTEM_USER_ID = "system"` from `auditLog.ts`; callers pass this for system-initiated operations (e.g. scheduled jobs, migrations). Requires the SYSTEM user seed above
- [ ] Do not throw on audit failure — catch errors and `console.error`; audit must never block the primary operation

### Route Wiring

Wire `logAuditEvent` calls into all existing mutation routes (after the primary DB operation succeeds):

- [ ] `committee/add`: log `MEMBER_ACTIVATED` (admin direct-add creates an active record); include `beforeValue=null`, `afterValue=membership`
- [ ] `committee/remove`: log `MEMBER_REMOVED`; include `beforeValue={status: previousStatus}`, `afterValue={status: "REMOVED", removalReason}`
- [ ] `committee/handleRequest` (accept): log `MEMBER_ACTIVATED`; include transition snapshot
- [ ] `committee/handleRequest` (reject): log `MEMBER_REJECTED`; include `rejectionNote` in `afterValue`
- [ ] `committee/requestAdd`: log `MEMBER_SUBMITTED`; include `beforeValue=null`, `afterValue={status: "SUBMITTED"}`

### Testing

- [ ] Unit tests for `logAuditEvent`:
  - Creates an `AuditLog` record with correct fields
  - Does not throw when Prisma create fails (logs to console.error)
- [ ] Integration tests for one wired route (e.g. `committee/add`): verify `AuditLog` record is created after a successful add

## Implementation Notes

- **Why last in Tier 1:** wiring requires all mutation routes to be updated (done in 1.2); running last ensures no repeated churn on routes
- **Admin UI:** deferred to ticket 3.5 — this ticket is infrastructure only
- **Override logging:** when `forceAdd` is used (ticket 2.1), log bypassed `IneligibilityReason` values in `metadata.bypassedReasons`
- **Schema spec:** [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2 — AuditLog model, §1 — AuditAction enum
- **PrivilegeLevel:** already exists in schema — `userRole` field uses existing enum

## Related

- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1 — AuditAction enum, §2 — AuditLog model
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.5, §11.1
- [3.5 Audit Log Admin UI](../SRS_IMPLEMENTATION_ROADMAP.md) — UI for viewing audit log (future)
- [2.1 Eligibility Validation](2.1-eligibility-validation.md) — override bypass is logged here
- [2.3 Resignation Workflow](2.3-resignation-workflow.md) — logs `MEMBER_RESIGNED` via this infrastructure
