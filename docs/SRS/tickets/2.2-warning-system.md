# 2.2 Warning System

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.2
**Effort:** 1–2 days
**Depends on:** [2.1 Eligibility Validation](2.1-eligibility-validation.md), [1.2 CommitteeMembership Model](1.2-committee-membership-model.md)

## Summary

Extend eligibility validation to return **non-blocking warnings** alongside hard stops. Warnings are surfaced in leader/admin submission flows, persisted as part of submission context, and logged for auditability. This ticket uses the derived inactive-voter strategy from [SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md](../SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md).

## Acceptance Criteria

### Warning Contract

- [x] Define a typed warning contract in the eligibility layer (stringly-typed warnings are not allowed):

```ts
type EligibilityWarningCode =
  | 'POSSIBLY_INACTIVE'
  | 'RECENT_RESIGNATION'
  | 'PENDING_IN_ANOTHER_COMMITTEE';

interface EligibilityWarning {
  code: EligibilityWarningCode;
  message: string;
  metadata?: Record<string, unknown>;
}
```

- [x] `validateEligibility(...)` returns:

```ts
{
  eligible: boolean;
  hardStops: IneligibilityReason[];
  warnings: EligibilityWarning[];
}
```

- [x] Warning generation never flips `eligible` to `false` by itself.

### Warning Rules

- [x] **Possibly inactive voter (`POSSIBLY_INACTIVE`)**
  - Implement via most-recent-import comparison per [SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md](../SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md) §4.
  - Use `VoterRecord.latestRecordEntryYear` + `latestRecordEntryNumber`.
  - If voter version is older than the latest version in the DB, add warning.
  - If no import version can be derived (empty DB), skip warning.

- [x] **Recent resignation (`RECENT_RESIGNATION`)**
  - Warning when voter has `CommitteeMembership.status=RESIGNED` with `resignedAt` within a rolling window.
  - v1 window: `90` days (single constant in eligibility service; TODO comment to move to config if needed).

- [x] **Pending submission in another LTED (`PENDING_IN_ANOTHER_COMMITTEE`)**
  - Warning when voter has `CommitteeMembership.status=SUBMITTED` in another `committeeListId` for the same active term.

### API Integration

- [x] Include warnings in successful responses for:
  - `POST /api/committee/add`
  - `POST /api/committee/requestAdd`
  - `POST /api/committee/handleRequest` (accept flow)
- [x] Preserve current hard-stop behavior from 2.1:
  - Hard stops => reject (422)
  - Warnings only => proceed (200/201)
- [x] Extend success response shape with `warnings?: EligibilityWarning[]`.

### Persistence + Audit

- [x] Persist warning snapshot when a membership record is created or status-transitioned due to add/request/accept:
  - `CommitteeMembership.submissionMetadata.eligibilityWarnings`
  - Keep existing metadata keys (`removeMemberId`, `requestNotes`, 2.1a contact fields) intact.
- [x] Add warning context to audit metadata on relevant events (`MEMBER_SUBMITTED`, `MEMBER_ACTIVATED`) as `metadata.eligibilityWarnings`.

### UI

- [x] `apps/frontend/src/app/committees/AddCommitteeForm.tsx`:
  - Render warnings as yellow banner(s) near submit controls.
  - Allow submit to proceed.
- [x] `apps/frontend/src/app/committees/CommitteeRequestForm.tsx`:
  - Show warnings returned from request submission.
- [x] `apps/frontend/src/app/committees/requests/RequestCard.tsx` (admin review):
  - If warning metadata exists on the pending request, display it before Accept/Reject.

### Preflight Endpoint

- [x] Add read-only endpoint for pre-submit checks:
  - `GET /api/committee/eligibility?voterRecordId=...&committeeListId=...`
  - Returns full `{ eligible, hardStops, warnings }`
- [x] Use this endpoint only for UX prefetch; mutation endpoints remain authoritative.

### Tests

- [x] Unit tests for warning derivation helper(s):
  - stale import version => `POSSIBLY_INACTIVE`
  - same import version => no inactive warning
  - recent resignation within 90 days => warning
  - resignation outside 90 days => no warning
  - submitted in another committee same term => warning
- [x] Route tests (`add`, `requestAdd`, `handleRequest`):
  - warnings-only path succeeds and returns warnings
  - hard-stop path still blocks
  - metadata persistence includes warning snapshot

## Implementation Notes

- **Primary source for inactive warning:** [SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md](../SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md) (derived-from-import approach), not BOE status field.
- **Location:** keep warning logic in the same service introduced by ticket 2.1 (`apps/frontend/src/app/api/lib/committeeValidation.ts` or extracted `eligibilityService.ts`).
- **Do not duplicate checks in UI:** frontend only renders server-returned warnings.
- **Performance:** most-recent-import query should run once per request context, not per warning rule.

## Implementation summary (for future changes)

Where to look when changing behavior:

| What | Location | Notes |
|------|----------|------|
| **Warning types** | `apps/frontend/src/lib/eligibility.ts` | `EligibilityWarningCode`, `EligibilityWarning`; add new codes here and in warning rules below. |
| **Most-recent-import helper** | `apps/frontend/src/app/api/lib/eligibilityService.ts` | `getMostRecentImportVersion`, `isVoterPossiblyInactive`. Full module comment references SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md; change inactive logic here. |
| **All warning rules** | `apps/frontend/src/lib/eligibility.ts` | After voter fetch: POSSIBLY_INACTIVE (uses eligibilityService), RECENT_RESIGNATION (90-day constant), PENDING_IN_ANOTHER_COMMITTEE. `getMostRecentImportVersion` is called once per `validateEligibility` call. |
| **Resignation window** | `apps/frontend/src/lib/eligibility.ts` | `RECENT_RESIGNATION_DAYS = 90`; TODO in code to move to config if needed. |
| **API response shape** | `apps/frontend/src/lib/validations/committee.ts` | `AddCommitteeResponse`, `CommitteeRequestResponse`; `CommitteeMembershipSubmissionMetadata.eligibilityWarnings`. |
| **Persistence** | `add/route.ts`, `requestAdd/route.ts`, `handleRequest/route.ts` | Merge `eligibility.warnings` into `submissionMetadata.eligibilityWarnings` and into audit `metadata.eligibilityWarnings`. |
| **Preflight** | `apps/frontend/src/app/api/committee/eligibility/route.ts` | GET handler; read-only. |
| **UI** | `AddCommitteeForm.tsx`, `CommitteeRequestForm.tsx`, `RequestCard.tsx` | Only render server-returned warnings (no client-side eligibility checks). Alert `variant="warning"` in `components/ui/alert.tsx`. |
| **Tests** | `__tests__/lib/eligibility.test.ts`, `__tests__/app/api/lib/eligibilityService.test.ts`, `__tests__/api/committee/add.test.ts`, `requestAdd.test.ts` | Warning rules and route persistence tests. `add.test.ts` uses typed refs (`setupEligibilityPassTyped`, `getMembershipMockTyped`) for mock imports. |

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.2, §7.2
- [SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md](../SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md)
- [2.1 Eligibility Validation](2.1-eligibility-validation.md)
- [2.1a Email/Phone Submission](2.1a-email-phone-submission.md)
- [SRS_GAPS_AND_CONSIDERATIONS.md](../SRS_GAPS_AND_CONSIDERATIONS.md) §1.2
