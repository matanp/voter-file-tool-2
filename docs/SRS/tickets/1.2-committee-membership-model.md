# 1.2 CommitteeMembership Model

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.2
**Effort:** 3–5 days
**Depends on:** [1.1 Committee Term Model](1.1-committee-term-model.md) (done)

## Summary

Introduce the `CommitteeMembership` model as the authoritative record for a voter's relationship to a committee. Replaces the binary `VoterRecord.committeeId` FK pattern with a full lifecycle-tracked record that persists through all status transitions and is never deleted. All committee mutations (add, remove, request) create or update `CommitteeMembership` records going forward.

## Acceptance Criteria

### Schema

- [x] New enums (add to `schema.prisma`):
  - `MembershipStatus`: `SUBMITTED`, `REJECTED`, `CONFIRMED`, `ACTIVE`, `RESIGNED`, `REMOVED`, `PETITIONED_WON`, `PETITIONED_LOST`, `PETITIONED_TIE`
  - `RemovalReason`: `PARTY_CHANGE`, `MOVED_OUT_OF_DISTRICT`, `INACTIVE_REGISTRATION`, `DECEASED`, `OTHER`
  - `ResignationMethod`: `EMAIL`, `MAIL`
- [x] New `CommitteeMembership` model per `SRS_DATA_MODEL_CHANGES.md` §2 — all fields including:
  - Core FKs: `voterRecordId`, `committeeListId`, `termId`
  - `status MembershipStatus @default(SUBMITTED)`, `membershipType MembershipType?`, `seatNumber Int?`
  - Lifecycle timestamps: `submittedAt`, `confirmedAt?`, `activatedAt?`, `resignedAt?`, `removedAt?`, `rejectedAt?`
  - `rejectionNote String?`, `submittedById String?`, `submissionMetadata Json?`
  - `meetingRecordId String?` (nullable FK to future `MeetingRecord`)
  - Resignation fields: `resignationDateReceived DateTime?`, `resignationMethod ResignationMethod?`
  - Removal fields: `removalReason RemovalReason?`, `removalNotes String?`
  - Petition fields: `petitionVoteCount Int?`, `petitionPrimaryDate DateTime?`
  - `@@unique([voterRecordId, committeeListId, termId])`
  - `@@index([committeeListId, termId, status])`, `@@index([termId, status])`, `@@index([voterRecordId])`

### Migration

- [x] Prisma migration that adds all new enums and the `CommitteeMembership` table
- [x] Data backfill: for every `VoterRecord` with a non-null `committeeId`, create a `CommitteeMembership` record with `status=ACTIVE`, `termId` = currently active `CommitteeTerm.id`, `submittedAt=now()`
- [x] Data backfill: migrate pending `CommitteeRequest` records to `CommitteeMembership` with `status=SUBMITTED`
- [x] Keep `VoterRecord.committeeId` FK in schema temporarily (backwards compatibility); mark as deprecated in code comment — removal deferred to ticket 3.0
- [x] Seed `CommitteeGovernanceConfig` if not already seeded (re-entrant: skip if row exists)

### API Route Updates

- [x] `committee/add`: create `CommitteeMembership` with `status=ACTIVE` (admin direct-add) instead of setting `VoterRecord.committeeId`; still enforce capacity (< `maxSeatsPerLted` active memberships for that committee+term)
- [x] `committee/remove`: set `CommitteeMembership.status=REMOVED`, `removedAt=now()`, `removalReason` from request body — do not delete the record
- [x] `committee/requestAdd`: create `CommitteeMembership` with `status=SUBMITTED` instead of creating `CommitteeRequest`
- [x] `committee/handleRequest`: transition `CommitteeMembership.status` from `SUBMITTED` → `ACTIVE` (accept) or `REJECTED` (reject) instead of operating on `CommitteeRequest`

### UI Updates

- [x] `CommitteeSelector.tsx`: query `CommitteeMembership` with `status=ACTIVE` and matching `termId` (active term) instead of `VoterRecord.committeeId`
- [x] `AddCommitteeForm.tsx`: submit to updated `committee/requestAdd` endpoint

### History Preservation

- [x] No deletions: all status changes update the existing record; `CommitteeMembership` is append-only in terms of records per unique constraint
- [x] Ensure previous-term memberships remain queryable (filter by `termId`)

## Implementation Notes

- **Remove-only CommitteeRequest records:** Records with `addVoterRecordId = null` (remove-only) are not migrated to CommitteeMembership. They remain in CommitteeRequest but are no longer visible in the UI. Per SRS, remove-only is an admin action; leaders should contact admins who can use the remove API directly.
- **Schema spec:** [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2 — CommitteeMembership model and enums
- **Migration order:** follows SRS_DATA_MODEL_CHANGES §5.3 steps 1–8; step 9 (drop `committeeId`) is deferred
- **Existing routes:** `apps/frontend/src/app/api/committee/`
- **Existing components:** `apps/frontend/src/app/committees/CommitteeSelector.tsx`, `AddCommitteeForm.tsx`
- **Capacity check:** use `CommitteeMembership` count where `status=ACTIVE AND committeeListId=X AND termId=Y`; must be < `CommitteeGovernanceConfig.maxSeatsPerLted`
- **`MeetingRecord` FK:** declare `meetingRecordId String?` without the relation constraint for now (relation added when `MeetingRecord` model is built in a later ticket); use `@map` if needed to keep column name consistent

## Related

- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2 — CommitteeMembership model, enums, migration
- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §5.3 — migration order
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.2
- [1.3 Membership Type](1.3-membership-type.md) — populates `membershipType` field added here
- [1.4 Seat Model](1.4-seat-model.md) — assigns `seatNumber` field added here
- [2.1 Eligibility Validation](2.1-eligibility-validation.md) — reads `CommitteeMembership` for capacity/duplicate checks
