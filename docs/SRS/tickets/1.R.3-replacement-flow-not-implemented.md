# 1.R.3 Replacement Flow Not Implemented in handleRequest Accept (P1)

**Status:** Resolved
**Priority:** P1 — High
**Effort:** 1–2 days
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md), [T1.1 handleRequest Route Tests](T1.1-handleRequest-route-tests.md)

## Summary

Replacement intent (add one member while removing another) is captured in submission metadata (`removeMemberId`) and surfaced in the UI (`RequestCard.tsx`, `CommitteeRequestForm.tsx`), but the `handleRequest` accept path **never reads** `submissionMetadata.removeMemberId`. It only activates the add-member and does not transition the remove-target to REMOVED. This conflicts with T1.1, which marks replacement coverage as done.

## Current State

- **Capture:** `requestAdd` stores `removeMemberId` in `submissionMetadata` (route.ts line 148)
- **UI:** `RequestCard.tsx` (line 94), `CommitteeRequestForm.tsx` (line 200) surface replacement UI
- **Accept path:** `handleRequest` route (line 49+) never reads `removeMemberId`; only activates the add-member

## Acceptance Criteria

- [x] On accept, when `membership.submissionMetadata?.removeMemberId` is present:
  - Find the target `CommitteeMembership` for that voter/committee/term (or resolve via `committeeListId` + `termId` from the accepted membership).
  - Transition the remove-target to `REMOVED` with `removedAt=now`, appropriate `removalReason` (e.g. `OTHER` with note "Replacement" or configurable), and audit `MEMBER_REMOVED`.
  - Then perform the existing add-member activation (seat assign, status=ACTIVE).
- [x] Run both transitions in a transaction for atomicity.
- [x] If remove-target is not found or not ACTIVE, return 422 with explicit error (e.g. "Replacement target not found or no longer active").
- [x] Update T1.1 tests to assert replacement behavior: accept with `removeMemberId` → target REMOVED, add-member ACTIVE.
- [x] Replacement was not deferred; implementation and tests are in place.

## Implementation Notes

- **File:** `apps/frontend/src/app/api/committee/handleRequest/route.ts`
- **Metadata shape:** `submissionMetadata: { removeMemberId?: string; requestNotes?: string }`
- Resolve remove-target: `CommitteeMembership` where `voterRecordId === removeMemberId`, `committeeListId` and `termId` match the accepted membership's committee.

## Related

- [T1.1 handleRequest Route Tests](T1.1-handleRequest-route-tests.md)
- [1.2 CommitteeMembership Model](1.2-committee-membership-model.md)
- [2.5 Structured Removal](2.5-structured-removal-reasons.md) — for `removalReason` values
