# 3.0 Report-server: Migrate ldCommittees to CommitteeMembership

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.0
**Effort:** 1–2 days
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md)

## Summary

Migrate the `ldCommittees` report data source in report-server from legacy `committeeMemberList` access patterns to `CommitteeMembership` (`status=ACTIVE`) so report generation remains correct after membership-model migration.

## Current State

The report-server's `fetchCommitteeData()` in `committeeMappingHelpers.ts` **already reads from `memberships`** (not `committeeMemberList`). The local `CommitteeWithMembers` type (lines 10–16) already uses `memberships?: (CommitteeMembership & { voterRecord: VoterRecord })[]`. However, the **shared** `CommitteeWithMembers` type in `packages/shared-validators/src/committeeUtils.ts` still references `committeeMemberList?: VoterRecord[]` (lines 7–9), and this legacy type may still be imported or used elsewhere.

**Key risk:** The shared type and any residual references to `committeeMemberList` in report schemas or type re-exports create a false compile-time safety net — code may typecheck against the wrong shape.

## Acceptance Criteria

### Data Fetching
- [ ] `fetchCommitteeData()` in `apps/report-server/src/committeeMappingHelpers.ts` reads `CommitteeList` with `memberships` filtered to `status=ACTIVE` and includes `voterRecord` — **verify current implementation is correct and complete**.
- [ ] The active term is resolved via the same `getActiveTermId()` pattern used in `apps/frontend/src/app/api/lib/committeeValidation.ts`, or report-server's own equivalent. Confirm the term filter is applied in the `where` clause.

### Type Cleanup
- [ ] `CommitteeWithMembers` type in `packages/shared-validators/src/committeeUtils.ts` is updated to use `memberships` (not `committeeMemberList`). The optional `committeeMemberList?: VoterRecord[]` field is removed.
- [ ] All imports of `CommitteeWithMembers` across the monorepo are audited — any consumer expecting `committeeMemberList` is updated.
- [ ] The local `CommitteeWithMembers` type in `apps/report-server/src/committeeMappingHelpers.ts` is either consolidated with the shared type or explicitly documented as the report-server's canonical type.

### Mapping & Transformation
- [ ] `mapCommitteesToReportShape()` in `committeeMappingHelpers.ts` consumes `memberships` end-to-end and produces `CommitteeReportStructure[]` grouped by `cityTown|legDistrict` then by `electionDistrict`.
- [ ] `mapVoterRecordToMember()` correctly converts `VoterRecord` (from `membership.voterRecord`) to `EnrichedPartialVoterRecordAPI` using `convertPrismaVoterRecordToAPI()` + `applyCompoundFields()`.

### Route Handler
- [ ] The `ldCommittees` handler in `apps/report-server/src/index.ts` (lines ~193–212) does not reference `committeeMemberList` anywhere.
- [ ] Both PDF and XLSX code paths call `fetchCommitteeData()` → `mapCommitteesToReportShape()` → render/generate.

### Shared Schema
- [ ] `packages/shared-validators/src/schemas/report.ts` — confirm `ldCommitteesReportSchema` does not encode `committeeMemberList` in its Zod shape.
- [ ] `packages/shared-validators/src/index.ts` — confirm no re-export of legacy committee-member types.

### Output Validation
- [ ] Generate an `ldCommittees` PDF report and visually confirm: landscape 11"×8.5", table columns (Serve ED, Name, Address, City, State, Zip, Phone), pagination at 30 rows/page, subtotals per LD page.
- [ ] Generate an `ldCommittees` XLSX report and confirm: one worksheet per LD ("LD 01", "LD 02", etc.), correct column ordering per `XLSXGenerationConfig`, field values match active membership data.
- [ ] Compare output against a pre-migration baseline if available, or create a baseline snapshot before making changes.

### Testing
- [ ] Update `apps/report-server/src/__tests__/committeeMappingHelpers.test.ts` to use `memberships` shape in test fixtures (remove any `committeeMemberList` fixtures).
- [ ] Add test: `fetchCommitteeData()` returns committees with `memberships` filtered to `status=ACTIVE` only (mock Prisma).
- [ ] Add test: `mapCommitteesToReportShape()` correctly groups by cityTown/legDistrict and maps member fields.
- [ ] Add test: empty committee (no active memberships) produces empty members array, not an error.

## Implementation Steps

Steps follow the AC order (Data Fetching → Type Cleanup → … → Testing):

1. **Verify report-server data fetching** — confirm `committeeMappingHelpers.ts` uses `memberships` correctly and term filter is applied; fix if not.
2. **Type cleanup** — grep the monorepo for `committeeMemberList`; update `committeeUtils.ts` to remove it from `CommitteeWithMembers`; fix downstream consumers; consolidate or document report-server’s local type.
3. **Mapping & transformation** — confirm `mapCommitteesToReportShape()` and `mapVoterRecordToMember()` consume `memberships` end-to-end.
4. **Route handler** — confirm the `ldCommittees` case in `processJob()` flows through the correct pipeline with no `committeeMemberList` references.
5. **Shared schema** — verify `report.ts` and `index.ts` have no legacy committee-member references.
6. **Output validation** — generate PDF and XLSX reports and compare output.
7. **Testing** — rewrite test fixtures to use the `memberships` shape; add tests per AC.

## Files to Modify

| File | Action |
|------|--------|
| `packages/shared-validators/src/committeeUtils.ts` | Remove `committeeMemberList` from `CommitteeWithMembers` type |
| `packages/shared-validators/src/index.ts` | Verify exports; remove legacy re-exports if any |
| `packages/shared-validators/src/schemas/report.ts` | Verify no `committeeMemberList` references |
| `apps/report-server/src/committeeMappingHelpers.ts` | Verify/fix `fetchCommitteeData()` and mapping; consolidate type |
| `apps/report-server/src/index.ts` | Verify `ldCommittees` handler |
| `apps/report-server/src/utils.ts` | Verify `transformToCommitteeMemberFormat()` |
| `apps/report-server/src/__tests__/committeeMappingHelpers.test.ts` | Update test fixtures |

## Closing note

Before closing this ticket, complete the [3.0a Audit and Update All Reports](3.0a-report-audit-committee-membership.md) checklist. Doing 3.0a in the same sprint as 3.0 is recommended.

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.0, §3.0a
- [1.R.5 Source-of-Truth Split](1.R.5-source-of-truth-split.md)
- [3.0a Audit and Update All Reports](3.0a-report-audit-committee-membership.md)

