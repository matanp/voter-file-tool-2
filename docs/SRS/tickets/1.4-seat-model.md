# 1.4 Seat Model

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.4
**Effort:** 3–5 days
**Depends on:** [1.1 Committee Term Model](1.1-committee-term-model.md) (done), [1.1c Governance Config](1.1c-committee-governance-config.md) (done), [1.2 CommitteeMembership Model](1.2-committee-membership-model.md)

## Resolved Decision

LTED total weight does **not** come from BOE exports. The authoritative source is MCDC's weighted table file, with manual entry as fallback. Both flows are implemented (manual entry in CommitteeSelector and bulk weighted-table import in Admin Data).
See [SRS_LTED_WEIGHT_SOURCE.md](../SRS_LTED_WEIGHT_SOURCE.md) for the final source decision and file format details.

## Summary

Introduce the `Seat` model to explicitly represent each seat slot within a committee for a given term. Seats track whether they were established via petition and carry a designation weight (LTED total weight / `maxSeatsPerLted`). On membership activation, the smallest unused seat number for that committee+term is assigned to the `CommitteeMembership`.

## Acceptance Criteria

### Schema

- [x] New `Seat` model per [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2:
  - `id String @id @default(cuid())`
  - `committeeListId Int` (FK → `CommitteeList.id`)
  - `termId String` (FK → `CommitteeTerm.id`)
  - `seatNumber Int` — 1-based, range 1–`maxSeatsPerLted`
  - `isPetitioned Boolean @default(false)` — immutable once set for the term
  - `weight Decimal?` — computed as `ltedWeight / maxSeatsPerLted`; null until LTED weight is known
  - `@@unique([committeeListId, termId, seatNumber])`
  - `@@index([committeeListId, termId])`
- [x] Add `ltedWeight Decimal?` field to `CommitteeList` model (per [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §3.1)
- [x] Add `seats Seat[]` relation to `CommitteeList` and `CommitteeTerm`

### Migration

- [x] Add `Seat` table and `CommitteeList.ltedWeight` column via Prisma migration
- [x] Backfill: create `maxSeatsPerLted` `Seat` records per `CommitteeList` per active term (read `maxSeatsPerLted` from `CommitteeGovernanceConfig`, not hardcoded)
- [x] Seat weights left null until `ltedWeight` is entered by admin

### Seat Assignment Logic

- [x] Helper function `assignNextAvailableSeat(committeeListId: number, termId: string): Promise<number>`:
  - Queries all `Seat` records for the given `committeeListId` + `termId`
  - Queries all `CommitteeMembership` records with `status=ACTIVE` and a non-null `seatNumber` for the same committee+term
  - Returns the smallest `seatNumber` (1-based) not currently occupied by an active membership
  - Throws if all seats are occupied (should not happen if capacity check in 1.2 passes first)
- [x] Call `assignNextAvailableSeat` when transitioning a `CommitteeMembership` to `ACTIVE` status (in `committee/add` and `committee/handleRequest`)
- [x] Set `CommitteeMembership.seatNumber` to the assigned value on activation

### Weight Computation

- [x] When `CommitteeList.ltedWeight` is set or updated, recompute and persist `Seat.weight = ltedWeight / maxSeatsPerLted` for all seats in that committee (current term)
- [x] Utility function `recomputeSeatWeights(committeeListId: number): Promise<void>` — called after admin sets `ltedWeight`

### Admin UI

- [x] Committee detail view (or admin data panel): editable "LTED Total Weight" field on `CommitteeList`
- [x] On save, call `recomputeSeatWeights` and display updated per-seat weight
- [x] Display seat roster: list seats 1–4 with occupant name (from active `CommitteeMembership` with matching `seatNumber`), `isPetitioned`, and `weight`

## Completed Implementation (Feb 2026)

- **seatUtils.ts:** `assignNextAvailableSeat`, `ensureSeatsExist`, `recomputeSeatWeights`
- **Migration:** `20260219054449_add_seat_model_and_lted_weight` with backfill
- **Routes:** `PATCH /api/committee/updateLtedWeight`, `POST /api/admin/weightedTable/import` (bulk LTED from MCDC Excel)
- **Seat creation:** `ensureSeatsExist` called in `committee/add`, `committee/handleRequest`, and `bulkLoadCommittees`
- **CommitteeSelector:** LTED weight input, seat roster with occupants

## Implementation Notes

- **`maxSeatsPerLted`:** always read from `CommitteeGovernanceConfig` singleton — never hardcode 4
- **Seat creation timing:** seats are created at migration time (backfill) and when a new term is activated; they are not created on-demand per member
- **`isPetitioned`:** set by the petition workflow (future ticket); this ticket creates seats with `isPetitioned=false` by default
- **Seat reuse after resignation:** when a member resigns, their `seatNumber` is freed — `assignNextAvailableSeat` will return it for the next activation
- **Schema spec:** [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2 (Seat), §3.1 (CommitteeList changes)
- **Weight source:** [SRS_LTED_WEIGHT_SOURCE.md](../SRS_LTED_WEIGHT_SOURCE.md)

## Related

- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2 — Seat model, §3.1 — CommitteeList changes
- [SRS_LTED_WEIGHT_SOURCE.md](../SRS_LTED_WEIGHT_SOURCE.md) — how LTED weight is sourced
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.4, §8.1, §8.2
- [1.2 CommitteeMembership Model](1.2-committee-membership-model.md) — `seatNumber` field populated by this ticket
- [1.1c Governance Config](1.1c-committee-governance-config.md) — `maxSeatsPerLted` source
- [2.7 Seat Weight Reports](../SRS_IMPLEMENTATION_ROADMAP.md) — consumes seat weights built here
