# 2.1 Eligibility Validation (Hard Stops)

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.1
**Effort:** 2–3 days
**Depends on:** [1.1b LTED-to-Assembly-District Mapping](1.1b-lted-assembly-district-mapping.md) (done), [1.1c Governance Config](1.1c-committee-governance-config.md) (done), [1.2 CommitteeMembership Model](1.2-committee-membership-model.md)

## Summary

Implement server-side eligibility validation as a reusable utility function. Called from all committee mutation routes, it checks hard stops (blocking ineligibility reasons) and returns structured results. Admins can bypass non-overridable-locked stops with `forceAdd + overrideReason`; bypassed reasons are logged to the audit trail.

## Acceptance Criteria

### Utility Function

- [ ] Create `apps/frontend/src/lib/eligibility.ts` exporting:

```ts
validateEligibility(
  voterRecordId: string,
  committeeListId: number,
  termId: string,
  options?: { forceAdd?: boolean; overrideReason?: string }
): Promise<{
  eligible: boolean;
  hardStops: IneligibilityReason[];
  warnings: string[];
}>
```

- [ ] Reads `CommitteeGovernanceConfig` singleton for all thresholds — **no hardcoded values**

### Hard Stop Checks (in order)

- [ ] **`NOT_REGISTERED`:** voter record exists in DB (`VoterRecord` with matching `VRCNUM`)
- [ ] **`PARTY_MISMATCH`:** `VoterRecord.party` matches `CommitteeGovernanceConfig.requiredPartyCode`
- [ ] **`ASSEMBLY_DISTRICT_MISMATCH`:** if `CommitteeGovernanceConfig.requireAssemblyDistrictMatch=true`, look up the LTED's `stateAssemblyDistrict` via `LtedDistrictCrosswalk` (using `committeeList.cityTown`, `committeeList.legDistrict`, `committeeList.electionDistrict`) and verify it matches `VoterRecord.stateAssmblyDistrict`; if crosswalk entry not found → treat as mismatch (hard stop)
- [ ] **`CAPACITY`:** count of `CommitteeMembership` records with `status=ACTIVE` for this `committeeListId + termId` is < `CommitteeGovernanceConfig.maxSeatsPerLted`
- [ ] **`ALREADY_IN_ANOTHER_COMMITTEE`:** voter has no `CommitteeMembership` with `status=ACTIVE` in a *different* `committeeListId` for the same `termId`

### Override Behavior

- [ ] If `forceAdd=true` is passed:
  - Hard stops that are NOT in `CommitteeGovernanceConfig.nonOverridableIneligibilityReasons` are bypassed
  - Hard stops that ARE in `nonOverridableIneligibilityReasons` remain blocking even with `forceAdd`
  - `overrideReason` is required when `forceAdd=true` and any stops are bypassed — return validation error if missing
  - Bypassed reasons logged to `AuditLog` via `logAuditEvent` with `metadata.bypassedReasons` and `metadata.overrideReason` (requires ticket 1.5; if 1.5 not done, add TODO comment)
- [ ] `eligible: true` is returned only when all remaining (non-bypassed) hard stops pass

### Route Integration

- [ ] Call `validateEligibility` at the start of:
  - `committee/add` (before creating membership)
  - `committee/requestAdd` (before creating submission)
  - `committee/handleRequest` accept path (before activating membership)
- [ ] On ineligibility: return `{ error: "INELIGIBLE", reasons: IneligibilityReason[] }` with HTTP 422
- [ ] Pass `forceAdd` from request body (Admin-only field); validate user is Admin before honoring

### UI

- [ ] `AddCommitteeForm.tsx`: display returned `IneligibilityReason` values as blocking error messages below the submit button; map enum values to human-readable strings
- [ ] Each `IneligibilityReason` maps to a distinct error message (define mapping in a shared constants file)

### Tests

- [ ] Unit tests for `validateEligibility` — each hard stop individually:
  - Voter not in DB → `NOT_REGISTERED`
  - Party mismatch → `PARTY_MISMATCH`
  - AD mismatch (crosswalk match fails) → `ASSEMBLY_DISTRICT_MISMATCH`
  - AD check when `requireAssemblyDistrictMatch=false` → no `ASSEMBLY_DISTRICT_MISMATCH` hard stop
  - Crosswalk entry missing → `ASSEMBLY_DISTRICT_MISMATCH`
  - At capacity (4 active) → `CAPACITY`
  - Already active in another committee → `ALREADY_IN_ANOTHER_COMMITTEE`
  - All checks pass → `eligible: true`, empty `hardStops`
  - `forceAdd=true` bypasses overridable stop → `eligible: true`
  - `forceAdd=true` does not bypass non-overridable stop → still blocked
  - `forceAdd=true` without `overrideReason` → validation error

## Implementation Notes

- **`IneligibilityReason` enum:** declared in [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1 and implemented in ticket 1.1c
- **`VoterRecord.stateAssmblyDistrict`:** note the typo in field name (missing 'e') — use the actual schema field name
- **Admin override spec:** [SRS_IMPLEMENTATION_ADMIN_OVERRIDE.md](../SRS_IMPLEMENTATION_ADMIN_OVERRIDE.md)
- **Crosswalk lookup:** join via `CommitteeList` fields; if `LtedDistrictCrosswalk` table is empty (crosswalk not yet loaded), and `requireAssemblyDistrictMatch=true`, the check will fail for all voters — document this in code comment

## Related

- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1 — `IneligibilityReason` enum
- [SRS_IMPLEMENTATION_ADMIN_OVERRIDE.md](../SRS_IMPLEMENTATION_ADMIN_OVERRIDE.md) — admin override flow
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.1, §7.1
- [1.1b LTED-to-Assembly-District Mapping](1.1b-lted-assembly-district-mapping.md) — provides `LtedDistrictCrosswalk`
- [1.1c Governance Config](1.1c-committee-governance-config.md) — provides all thresholds
- [1.2 CommitteeMembership Model](1.2-committee-membership-model.md) — provides membership records for capacity/duplicate checks
- [1.5 Audit Trail Infrastructure](1.5-audit-trail-infrastructure.md) — logs override bypass events
- [2.1a Email/Phone Submission](2.1a-email-phone-submission.md) — parallel Tier 2 ticket
