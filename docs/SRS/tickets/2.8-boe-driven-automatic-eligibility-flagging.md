# 2.8 BOE-Driven Automatic Eligibility Flagging

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.8
**Effort:** 3–5 days
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md), [2.1 Eligibility Validation](2.1-eligibility-validation.md), [2.5 Structured Removal](2.5-structured-removal-reasons.md), [2.2 Warning System](2.2-warning-system.md)

## Summary

After each BOE voter import, automatically flag active committee members whose eligibility may have changed. Provide an admin review queue to confirm removal or dismiss each flag. Include a manual rerun action for ad hoc checks.

## Acceptance Criteria

### New Queue Model

- [ ] Add queue model to `apps/frontend/prisma/schema.prisma`:

```prisma
enum EligibilityFlagReason {
  PARTY_MISMATCH
  ASSEMBLY_DISTRICT_MISMATCH
  VOTER_NOT_FOUND
  POSSIBLY_INACTIVE
}

enum EligibilityFlagStatus {
  PENDING
  CONFIRMED
  DISMISSED
}

model EligibilityFlag {
  id                   String               @id @default(cuid())
  membershipId         String
  membership           CommitteeMembership  @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  committeeListId      Int
  voterRecordId        String
  termId               String
  reason               EligibilityFlagReason
  status               EligibilityFlagStatus @default(PENDING)
  details              Json?
  sourceReportId       String?
  reviewedById         String?
  reviewedBy           User?                @relation("EligibilityFlagsReviewed", fields: [reviewedById], references: [id])
  reviewedAt           DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([status, createdAt])
  @@index([committeeListId, termId])
  @@unique([membershipId, reason, status])
}
```

- [ ] Add relation on `User`:

```prisma
reviewedEligibilityFlags EligibilityFlag[] @relation("EligibilityFlagsReviewed")
```

### Flagging Processor Logic

- [ ] Implement processor service (shared, callable by worker + manual API):
  - Input: termId (default active), optional source report id.
  - Scope: all `CommitteeMembership` with `status=ACTIVE` for target term.
  - For each active membership, evaluate:
    - party mismatch vs governance config
    - AD mismatch (if AD check enabled)
    - voter record missing
    - possibly inactive (same derived rule as 2.2)
  - Create/update `EligibilityFlag` records in `PENDING` state.

- [ ] Duplicate behavior:
  - Do not create duplicate pending flag for same `(membershipId, reason)`.
  - If a previously dismissed reason reappears on a later run, create new pending flag.

### Automatic Trigger After BOE Import

- [ ] Extend report-server job schema and queue to include a new job type: `boeEligibilityFlagging`.
- [ ] In `apps/report-server/src/index.ts`:
  - After successful `voterImport` processing, enqueue `boeEligibilityFlagging` job automatically.
  - No feature toggle; always runs.
- [ ] In shared validators:
  - update `packages/shared-validators/src/schemas/report.ts` discriminated unions for new type.
  - update `packages/shared-validators/src/reportTypeMapping.ts` if a persisted report row is used.

### Manual Trigger

- [ ] Create `POST /api/admin/eligibility-flags/run`:
  - Admin-only.
  - Starts the same flagging processor without re-import.
  - Optional payload: `{ termId?: string }`.
  - Returns run summary (`scanned`, `newFlags`, `existingPending`, `durationMs`).

### Review Queue API

- [ ] Create `GET /api/admin/eligibility-flags`:
  - Admin-only.
  - Filters: status, reason, term, committee.
  - Includes membership + voter + committee context.

- [ ] Create `POST /api/admin/eligibility-flags/[id]/review`:

```ts
{
  decision: "confirm" | "dismiss";
  notes?: string;
}
```

- [ ] Review behavior:
  - `dismiss` -> `status=DISMISSED`, `reviewedById`, `reviewedAt`, optional notes in details.
  - `confirm` -> apply removal through the structured removal path (2.5), then set flag `status=CONFIRMED`.

- [ ] Reason to `RemovalReason` mapping on confirm:
  - `PARTY_MISMATCH` -> `PARTY_CHANGE`
  - `ASSEMBLY_DISTRICT_MISMATCH` -> `MOVED_OUT_OF_DISTRICT`
  - `POSSIBLY_INACTIVE` -> `INACTIVE_REGISTRATION`
  - `VOTER_NOT_FOUND` -> `OTHER` (notes: "Voter not present in latest import")

### Admin UI

- [ ] Enable `/admin/eligibility-flags` in `apps/frontend/src/config/adminNav.ts`.
- [ ] Add page and client components:
  - `apps/frontend/src/app/admin/eligibility-flags/page.tsx`
  - `apps/frontend/src/app/admin/eligibility-flags/EligibilityFlagsTable.tsx`
  - `apps/frontend/src/app/admin/eligibility-flags/EligibilityFlagReviewDialog.tsx`
- [ ] UI requirements:
  - Table columns: member, committee, reason, detected date, status.
  - Row actions: Confirm removal / Dismiss.
  - "Run eligibility check" button invoking manual trigger endpoint.

### Audit Logging

- [ ] Log queue events:
  - `DISCREPANCY_RESOLVED` when flag dismissed or confirmed (metadata includes flag id/reason/decision).
- [ ] Confirm-removal path must also emit `MEMBER_REMOVED` with `metadata.source="boe_flagging"`.

### Tests

- [ ] Processor tests:
  - detects each reason correctly
  - avoids duplicate pending flags
  - creates new pending flag after prior dismissal when issue recurs
- [ ] Worker integration test:
  - voter import completion enqueues flagging job
- [ ] API tests:
  - list/filter queue
  - confirm applies removal + status change
  - dismiss updates status only
- [ ] UI integration test for review table action flow.

## Implementation Notes

- **Keep separate from `CommitteeUploadDiscrepancy`:** this queue is lifecycle eligibility-specific and term-scoped; avoid overloading upload discrepancy tables.
- **Source-of-truth checks:** use same eligibility rule helpers as 2.1/2.2 to prevent drift.
- **Operational safety:** run flagging asynchronously; never block voter import completion webhook.

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.8, §6.6
- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §6
- [2.1 Eligibility Validation](2.1-eligibility-validation.md)
- [2.2 Warning System](2.2-warning-system.md)
- [2.5 Structured Removal](2.5-structured-removal-reasons.md)
- [SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md](../SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md)
