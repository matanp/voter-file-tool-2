# 2.8 BOE-Driven Automatic Eligibility Flagging

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.8
**Effort:** 3–5 days
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md), [2.1 Eligibility Validation](2.1-eligibility-validation.md), [2.5 Structured Removal](2.5-structured-removal-reasons.md), [2.2 Warning System](2.2-warning-system.md)

## Summary

After each BOE voter import, automatically flag active committee members whose eligibility may have changed. Provide an admin review queue to confirm removal or dismiss each flag. Include a manual rerun action for ad hoc checks.

## Acceptance Criteria

### New Queue Model

- [x] Add queue model to `apps/frontend/prisma/schema.prisma`:

```prisma
enum EligibilityFlagReason {
  PARTY_MISMATCH
  ASSEMBLY_DISTRICT_MISMATCH
  VOTER_NOT_FOUND
  POSSIBLY_INACTIVE
}

enum EligibilityFlagStatus {
  PENDING
  CONFIRMED
  DISMISSED
}

model EligibilityFlag {
  id                   String               @id @default(cuid())
  membershipId         String
  membership           CommitteeMembership  @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  committeeListId      Int
  voterRecordId        String
  termId               String
  reason               EligibilityFlagReason
  status               EligibilityFlagStatus @default(PENDING)
  details              Json?
  sourceReportId       String?
  reviewedById         String?
  reviewedBy           User?                @relation("EligibilityFlagsReviewed", fields: [reviewedById], references: [id])
  reviewedAt           DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([status, createdAt])
  @@index([committeeListId, termId])
  @@index([membershipId, reason, status])
}
```

- [x] Enforce "one pending flag per `(membershipId, reason)`" using a DB partial unique index in migration SQL:
  - `apps/frontend/prisma/migrations/20260221103000_fix_eligibility_flag_pending_uniqueness/migration.sql`

- [x] Add relation on `User`:

```prisma
reviewedEligibilityFlags EligibilityFlag[] @relation("EligibilityFlagsReviewed")
```

### Flagging Processor Logic

- [x] Implement processor service (shared, callable by worker + manual API):
  - Input: termId (default active), optional source report id.
  - Scope: all `CommitteeMembership` with `status=ACTIVE` for target term.
  - For each active membership, evaluate:
    - party mismatch vs governance config
    - AD mismatch (if AD check enabled)
    - voter record missing
    - possibly inactive (same derived rule as 2.2)
  - Create/update `EligibilityFlag` records in `PENDING` state.

- [x] Duplicate behavior:
  - Do not create duplicate pending flag for same `(membershipId, reason)`.
  - If a previously dismissed reason reappears on a later run, create new pending flag.

### Automatic Trigger After BOE Import

- [x] Extend report-server job schema and queue to include a new job type: `boeEligibilityFlagging`.
- [x] In `apps/report-server/src/index.ts`:
  - After successful `voterImport` processing, enqueue `boeEligibilityFlagging` job automatically.
  - No feature toggle; always runs.
  - Implement chaining via an internal job-orchestration map (for example: `voterImport -> boeEligibilityFlagging`) so follow-up jobs are centrally defined and extensible.
  - For testing, allow injecting/overriding the orchestration map (including an empty map) without changing production runtime behavior.
- [x] In shared validators:
  - update `packages/shared-validators/src/schemas/report.ts` discriminated unions for new type.
  - update `packages/shared-validators/src/reportTypeMapping.ts` if a persisted report row is used.

### Manual Trigger

- [x] Create `POST /api/admin/eligibility-flags/run`:
  - Admin-only.
  - Starts the same flagging processor without re-import.
  - Optional payload: `{ termId?: string }`.
  - Returns run summary (`scanned`, `newFlags`, `existingPending`, `durationMs`).

### Review Queue API

- [x] Create `GET /api/admin/eligibility-flags`:
  - Admin-only.
  - Filters: status, reason, term, committee.
  - Includes membership + voter + committee context.

- [x] Create `POST /api/admin/eligibility-flags/[id]/review`:

```ts
{
  decision: "confirm" | "dismiss";
  notes?: string;
}
```

- [x] Review behavior:
  - `dismiss` -> `status=DISMISSED`, `reviewedById`, `reviewedAt`, optional notes in details.
  - `confirm` -> apply removal through the structured removal path (2.5), then set flag `status=CONFIRMED`.

- [x] Reason to `RemovalReason` mapping on confirm:
  - `PARTY_MISMATCH` -> `PARTY_CHANGE`
  - `ASSEMBLY_DISTRICT_MISMATCH` -> `MOVED_OUT_OF_DISTRICT`
  - `POSSIBLY_INACTIVE` -> `INACTIVE_REGISTRATION`
  - `VOTER_NOT_FOUND` -> `OTHER` (notes: "Voter not present in latest import")

### Admin UI

- [x] Enable `/admin/eligibility-flags` in `apps/frontend/src/config/adminNav.ts`.
- [x] Add page and client components:
  - `apps/frontend/src/app/admin/eligibility-flags/page.tsx`
  - `apps/frontend/src/app/admin/eligibility-flags/EligibilityFlagsTable.tsx`
  - `apps/frontend/src/app/admin/eligibility-flags/EligibilityFlagReviewDialog.tsx`
- [x] UI requirements:
  - Table columns: member, committee, reason, detected date, status.
  - Row actions: Confirm removal / Dismiss.
  - "Run eligibility check" button invoking manual trigger endpoint.

### Audit Logging

- [x] Log queue events:
  - `DISCREPANCY_RESOLVED` when flag dismissed or confirmed (metadata includes flag id/reason/decision).
- [x] Confirm-removal path must also emit `MEMBER_REMOVED` with `metadata.source="boe_flagging"`.

### Tests

- [x] Processor tests:
  - detects each reason correctly
  - avoids duplicate pending flags
  - creates new pending flag after prior dismissal when issue recurs
- [x] Worker integration test:
  - voter import completion enqueues flagging job
- [x] API tests:
  - list/filter queue
  - confirm applies removal + status change
  - dismiss updates status only
- [x] UI integration test for review table action flow.

## Implementation Review (2026-02-21)

### Resolved Findings

1. **Repeat review-cycle constraint issue fixed.**
   - Replaced broad status-based uniqueness with a pending-only partial unique index:
     - one pending row per `(membershipId, reason)`, unlimited historical confirmed/dismissed rows.
   - This removes recurrence collisions when reviewing re-flagged memberships.

2. **Processor now updates existing pending rows.**
   - Existing pending flags are refreshed with updated `details` and `sourceReportId` when rerun detects the same reason again.

3. **Missing integration tests added.**
   - Worker test now covers voter-import completion enqueueing the follow-up BOE flagging job.
   - UI test now covers review-table action flow through confirm-removal and refresh.

### Validation Run

- `pnpm --filter @voter-file-tool/shared-prisma build` passed.
- `pnpm --filter @voter-file-tool/shared-validators build` passed.
- `pnpm --filter node-pdf-generation test -- --runInBand src/__tests__/jobOrchestration.test.ts` passed.
- `pnpm --filter voter-file-tool test -- --runInBand src/__tests__/api/admin/eligibilityFlags.test.ts src/__tests__/lib/boeEligibilityFlagging.test.ts src/__tests__/app/admin/eligibility-flags/EligibilityFlagReviewDialog.test.tsx` passed.
- `pnpm --filter voter-file-tool test -- --runInBand src/__tests__/app/admin/eligibility-flags/EligibilityFlagsTable.test.tsx` passed.

## Implementation Notes

- **Keep separate from `CommitteeUploadDiscrepancy`:** this queue is lifecycle eligibility-specific and term-scoped; avoid overloading upload discrepancy tables.
- **Source-of-truth checks:** use same eligibility rule helpers as 2.1/2.2 to prevent drift.
- **Operational safety:** run flagging asynchronously; never block voter import completion webhook.

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.8, §6.6
- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §6
- [2.1 Eligibility Validation](2.1-eligibility-validation.md)
- [2.2 Warning System](2.2-warning-system.md)
- [2.5 Structured Removal](2.5-structured-removal-reasons.md)
- [SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md](../SRS_IMPLEMENTATION_INACTIVE_VOTER_WARNING.md)
