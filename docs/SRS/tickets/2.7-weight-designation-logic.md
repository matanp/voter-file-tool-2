# 2.7 Weight / Designation Logic

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.7
**Effort:** 3–5 days
**Depends on:** [1.4 Seat Model](1.4-seat-model.md), [2.6 Petition Outcomes](2.6-petition-primary-outcome-tracking.md)

## Summary

Implement the designation-weight calculation engine that determines how much weight a committee contributes based on petitioned seats and current occupancy. Expose this via API for UI and reporting.

## Acceptance Criteria

### Core Calculation Utility

- [ ] Create `apps/frontend/src/lib/designationWeight.ts`:

```ts
export type SeatContribution = {
  seatNumber: number;
  isPetitioned: boolean;
  isOccupied: boolean;
  occupantMembershipType: "PETITIONED" | "APPOINTED" | null;
  seatWeight: number | null;
  contributes: boolean;
  contributionWeight: number;
};

export async function calculateDesignationWeight(
  committeeListId: number,
  termId: string,
): Promise<{
  totalWeight: number;
  totalContributingSeats: number;
  seats: SeatContribution[];
}>;
```

- [ ] Rules implemented exactly:
  - Only `Seat.isPetitioned=true` seats can contribute.
  - A petitioned seat contributes only when occupied by an `ACTIVE` membership with matching `seatNumber`.
  - Vacant petitioned seats contribute zero.
  - Appointed members in petitioned seats contribute the full seat weight.
  - Members in non-petitioned seats contribute zero.

- [ ] Numeric handling:
  - Use Prisma `Decimal` internally when reading seat weights.
  - Convert to number only at response boundary.
  - Round display values to 4 decimal places in UI/report layers.

### API

- [ ] Create `GET /api/committee/designationWeight`:
  - Query params: `committeeListId`, optional `termId` (defaults to active term).
  - Access: Admin always; leader scoped to permitted jurisdictions.
  - Response includes full per-seat breakdown + total.

- [ ] Add optional include on committee fetch endpoint:
  - `GET /api/fetchCommitteeList` may include `designationWeightSummary` to avoid extra client calls.

### UI

- [ ] `apps/frontend/src/app/committees/CommitteeSelector.tsx`:
  - Show summary block once committee selected:
    - `Vacancy` (existing count)
    - `Designation Weight` (computed total)
  - For unavailable weights, display `—` (not `0`) to indicate missing source data.

- [ ] `apps/frontend/src/app/admin/terms/TermsManagement.tsx` or relevant admin committee view:
  - Add debug/verification table of seat-level contribution breakdown (seat number, petitioned, occupied, contribution).

### Reporting Integration

- [ ] Add shared helper in report-server to consume weight breakdown when generating 3.3/3.4 reports.
- [ ] Keep ticket scope to API + helper; report rendering pages can consume in later tickets.

### Edge Cases

- [ ] If any petitioned seat has `weight=null`, exclude from total and include diagnostic metadata (`missingWeightSeatNumbers`).
- [ ] If duplicate active memberships occupy same seat number (data integrity bug), throw deterministic error and capture to Sentry.

### Tests

- [ ] Unit tests for `calculateDesignationWeight`:
  - no petitioned seats => total `0`
  - petitioned+occupied => contributes
  - petitioned+vacant => zero
  - non-petitioned+occupied => zero
  - appointed occupant in petitioned seat => contributes
  - missing seat weight => excluded + metadata
- [ ] Route tests for `/api/committee/designationWeight` auth and payload shape.

## Implementation Notes

- **Weight source:** [SRS_LTED_WEIGHT_SOURCE.md](../SRS_LTED_WEIGHT_SOURCE.md) is authoritative; BOE import is not the source.
- **Prerequisite integrity:** this ticket assumes `Seat.weight` is already maintained by ticket 1.4.
- **Do not infer petitioned status from membership type:** petitioned/non-petitioned is a seat property (`Seat.isPetitioned`).

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §2.7, §8
- [SRS_LTED_WEIGHT_SOURCE.md](../SRS_LTED_WEIGHT_SOURCE.md)
- [SRS_GAPS_AND_CONSIDERATIONS.md](../SRS_GAPS_AND_CONSIDERATIONS.md) §1.1
- [1.4 Seat Model](1.4-seat-model.md)
- [2.6 Petition Outcomes](2.6-petition-primary-outcome-tracking.md)
