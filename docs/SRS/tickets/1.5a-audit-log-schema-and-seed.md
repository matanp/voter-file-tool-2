# 1.5a Audit Log Schema & SYSTEM User Seed

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.5
**Effort:** 1–2 days
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md) (done)

## Summary

Add the `AuditAction` enum, the `AuditLog` model, and the `AuditLogs` relation on `User` to the Prisma schema. Seed a well-known SYSTEM user for system-initiated audit events. Run the Prisma migration. No application code changes — this is schema-only groundwork for 1.5b and 1.5c.

## Acceptance Criteria

### Schema

- [ ] New `AuditAction` enum in `schema.prisma` per [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1:
  ```prisma
  enum AuditAction {
    MEMBER_SUBMITTED
    MEMBER_REJECTED
    MEMBER_CONFIRMED
    MEMBER_ACTIVATED
    MEMBER_RESIGNED
    MEMBER_REMOVED
    PETITION_RECORDED
    MEETING_CREATED
    REPORT_GENERATED
    TERM_CREATED
    JURISDICTION_ASSIGNED
    DISCREPANCY_RESOLVED
  }
  ```

- [ ] New `AuditLog` model in `schema.prisma` per [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §2:
  ```prisma
  model AuditLog {
    id          String         @id @default(cuid())
    userId      String
    user        User           @relation("AuditLogs", fields: [userId], references: [id])
    userRole    PrivilegeLevel
    action      AuditAction
    entityType  String         // e.g. "CommitteeMembership", "MeetingRecord"
    entityId    String         // ID of the affected record
    timestamp   DateTime       @default(now())
    beforeValue Json?          // Snapshot before change
    afterValue  Json?          // Snapshot after change
    metadata    Json?          // Additional context (override reason, bypass notes, etc.)

    @@index([entityType, entityId])
    @@index([userId])
    @@index([timestamp])
    @@index([action])
  }
  ```

- [ ] Add `auditLogs AuditLog[] @relation("AuditLogs")` to the `User` model

### Migration

- [ ] Run `pnpm db_migrate` to generate and apply the Prisma migration
- [ ] Verify migration creates the `AuditAction` enum, `AuditLog` table with all columns and indexes, and updates the `User` table with the relation

### SYSTEM User Seed

- [ ] In `apps/frontend/prisma/seed.ts`, add a re-entrant upsert for the SYSTEM user:
  ```typescript
  const systemUser = await prisma.user.upsert({
    where: { id: "system" },
    update: {},
    create: {
      id: "system",
      email: "system@internal",
      name: "System",
      privilegeLevel: PrivilegeLevel.Developer,
    },
  });
  ```
- [ ] The SYSTEM user is required because `AuditLog.userId` is a non-nullable FK — a bare string sentinel would violate referential integrity
- [ ] Upsert is re-entrant: running `pnpm db_seed` multiple times must not fail

### Validation

- [ ] `npx prisma validate` passes
- [ ] `npx prisma generate` produces updated client types
- [ ] Seed runs successfully against a fresh and existing database

## Implementation Notes

- **Placement in schema:** Add the `AuditAction` enum near the other enums (after `ResignationMethod`). Add the `AuditLog` model after `CommitteeMembership`.
- **SYSTEM user `privilegeLevel`:** Uses `Developer` (highest existing level). The SYSTEM user is a technical placeholder for FK integrity; it will never authenticate. A comment in `seed.ts` should note this.
- **No application code:** This ticket does not create the utility function or wire any routes. That work is in [1.5b](1.5b-audit-log-utility-and-immutability.md) and [1.5c](1.5c-audit-log-route-wiring.md).
- **`User.id` for SYSTEM:** The default `@default(cuid())` auto-generates IDs, but `create: { id: "system" }` explicitly sets the ID. This is valid in Prisma — the `@default` only applies when no value is provided.

## Related

- [SRS_DATA_MODEL_CHANGES.md](../SRS_DATA_MODEL_CHANGES.md) §1 — AuditAction enum, §2 — AuditLog model
- [1.5 Audit Trail Infrastructure](1.5-audit-trail-infrastructure.md) — parent ticket
- [1.5b Audit Log Utility & Immutability](1.5b-audit-log-utility-and-immutability.md) — next step
- [1.5c Audit Log Route Wiring](1.5c-audit-log-route-wiring.md) — final step
