# 1.R.1 Leader Privilege Escalation (P0)

**Status:** Resolved
**Priority:** P0 — Critical (Security)
**Effort:** 0.5 day
**Depends on:** Nothing

## Summary

Leader was added to the `PrivilegeLevel` enum in the Prisma schema (SRS §3.2 — jurisdiction-scoped committee leaders), but `hasPermissionFor` does not include `Leader` in its `permissionOrder` array. As a result, `indexOf(Leader)` returns `-1`, and `hasPermissionFor(Leader, Admin)` incorrectly evaluates to `true`. This is a **privilege-escalation bug**: Leaders can hit Admin-only routes protected by `withPrivilege(PrivilegeLevel.Admin, ...)`.

## Root Cause

- **File:** `apps/frontend/src/lib/utils.ts` (line 21)
- `permissionOrder` currently: `[Developer, Admin, RequestAccess, ReadAccess]`
- `Leader` is absent → `indexOf(Leader) === -1`
- Comparison `-1 <= indexOf(Admin)` is `true` → Leaders pass Admin checks

## Acceptance Criteria

- [x] Add `Leader` to `permissionOrder` in `hasPermissionFor` with correct ordering:
  - Leader should have privileges **above** RequestAccess/ReadAccess (can submit requests) but **below** Admin (cannot accept/reject, run bulk imports, etc.).
  - Suggested order: `Developer > Admin > Leader > RequestAccess > ReadAccess`
- [x] Verify all `withPrivilege(PrivilegeLevel.Admin, ...)` routes reject Leader users with 403.
- [x] Verify Leader can still access Leader-scoped routes (e.g. `requestAdd` at RequestAccess or appropriate level).
- [x] Add/update unit tests for `hasPermissionFor` covering Leader vs Admin, Leader vs RequestAccess.

## Implementation Notes

- **File to fix:** `apps/frontend/src/lib/utils.ts`
- **Auth gate:** `apps/frontend/src/app/api/lib/withPrivilege.ts` (line 53) uses `hasPermissionFor`
- Ensure Leader is placed between Admin and RequestAccess in the ordered array.
- **Fail-safe:** Unknown roles (new enum values not yet in `PRIVILEGE_ORDER`) return `false` — no privileges until explicitly supported.

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.2
- [CODE_REVIEW_RECOMMENDATIONS.md](../../CODEBASE_AUDIT/CODE_REVIEW_RECOMMENDATIONS.md)
