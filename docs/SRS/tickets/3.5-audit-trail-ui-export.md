# 3.5 Audit Trail UI and Export

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.5
**Effort:** 3–5 days
**Depends on:** [1.5 Audit Trail Infrastructure](1.5-audit-trail-infrastructure.md)

## Summary

Implement the admin-facing audit trail viewer at `/admin/audit` with a filterable, paginated table, detail view with before/after snapshots, and CSV/XLSX export. The data layer (AuditLog model, `logAuditEvent()` utility, immutability guard) is already complete from ticket 1.5.

## Current State

- **AuditLog model** exists in `apps/frontend/prisma/schema.prisma` (lines 408–425) with fields: `id`, `userId`, `userRole`, `action`, `entityType`, `entityId`, `timestamp`, `beforeValue`, `afterValue`, `metadata`.
- **AuditAction enum** has 12 values: `MEMBER_SUBMITTED`, `MEMBER_REJECTED`, `MEMBER_CONFIRMED`, `MEMBER_ACTIVATED`, `MEMBER_RESIGNED`, `MEMBER_REMOVED`, `PETITION_RECORDED`, `MEETING_CREATED`, `REPORT_GENERATED`, `TERM_CREATED`, `JURISDICTION_ASSIGNED`, `DISCREPANCY_RESOLVED`.
- **Indexes** exist on `[entityType, entityId]`, `[userId]`, `[timestamp]`, `[action]`.
- **Immutability guard** at `apps/frontend/src/lib/auditLogGuard.ts` prevents update/delete.
- **Logging function** at `apps/frontend/src/lib/auditLog.ts` — `logAuditEvent()` is wired into all mutation routes.
- **Nav item** exists but is disabled in `apps/frontend/src/config/adminNav.ts`: `{ id: "audit", label: "Audit Trail", href: "/admin/audit", enabled: false }`.

## Acceptance Criteria

> **Note:** The checklist below documents requirements; completion is tracked via implementation and manual verification rather than per-item checkmarks. All criteria have been validated; ticket status is Done.

### API Routes

#### List/Filter Endpoint

- [ ] `GET /api/admin/audit` — Paginated, filterable audit log query.
  - **Query params**:
    - `page` (number, default 1)
    - `pageSize` (number, default 25, max 100)
    - `action` (AuditAction enum value, optional — filter to single action type)
    - `entityType` (string, optional — e.g., "CommitteeMembership", "MeetingRecord")
    - `userId` (string, optional — filter to specific user)
    - `dateFrom` (ISO date string, optional)
    - `dateTo` (ISO date string, optional)
    - `sortBy` (enum: 'timestamp' | 'action', default 'timestamp')
    - `sortOrder` (enum: 'asc' | 'desc', default 'desc')
  - **Response**:
    ```ts
    {
      items: AuditLogEntry[],  // includes user.name, user.email
      total: number,
      page: number,
      pageSize: number,
      totalPages: number,
    }
    ```
  - **Prisma query pattern**: Use `findMany` with `where` clause built from filters, `include: { user: { select: { name: true, email: true } } }`, `orderBy`, `skip`, `take`.
  - **Admin only** — use `withPrivilege(PrivilegeLevel.Admin, handler)`.

#### Detail Endpoint

- [ ] `GET /api/admin/audit/[id]` — Full audit log entry with before/after values.
  - Returns the complete `AuditLog` record including `beforeValue`, `afterValue`, `metadata` JSON fields.
  - Admin only.

#### Export Endpoint

- [ ] `GET /api/admin/audit/export` — Export filtered results.
  - **Same filter params** as list endpoint (action, entityType, userId, dateFrom, dateTo) but no pagination — exports all matching records.
  - **Query param**: `format` (enum: 'csv' | 'xlsx', default 'csv').
  - **Response**: Streamed file download with appropriate Content-Type and Content-Disposition headers.
  - **Row limit**: Cap at 10,000 rows to prevent memory issues. If more, return 400 with message "Too many records — narrow your filters."
  - **CSV columns**: Timestamp, User Name, User Email, User Role, Action, Entity Type, Entity ID, Summary.
  - **XLSX columns**: Same + Before Value (JSON string), After Value (JSON string), Metadata (JSON string).

### Admin UI — `/admin/audit` Page

#### Navigation

- [ ] Enable the "Audit Trail" nav item in `apps/frontend/src/config/adminNav.ts` (`enabled: true`).
- [ ] Create page at `apps/frontend/src/app/admin/audit/page.tsx` (server component with `AuthCheck`).
- [ ] Create client component `apps/frontend/src/app/admin/audit/AuditTrailClient.tsx`.

#### Filter Bar

- [ ] Implement a horizontal filter bar at the top of the page:
  - **Action filter** — Dropdown/multi-select of `AuditAction` values with human-readable labels:
    - `MEMBER_SUBMITTED` → "Member Submitted"
    - `MEMBER_REJECTED` → "Member Rejected"
    - `MEMBER_CONFIRMED` → "Member Confirmed"
    - `MEMBER_ACTIVATED` → "Member Activated"
    - `MEMBER_RESIGNED` → "Member Resigned"
    - `MEMBER_REMOVED` → "Member Removed"
    - `PETITION_RECORDED` → "Petition Recorded"
    - `MEETING_CREATED` → "Meeting Created"
    - `REPORT_GENERATED` → "Report Generated"
    - `TERM_CREATED` → "Term Created"
    - `JURISDICTION_ASSIGNED` → "Jurisdiction Assigned"
    - `DISCREPANCY_RESOLVED` → "Discrepancy Resolved"
  - **Entity type filter** — Dropdown with common entity types: "CommitteeMembership", "MeetingRecord", "CommitteeTerm", "Report" (populated from distinct values or hardcoded list).
  - **User filter** — `ComboboxDropdown` searching admin/leader users by name/email.
  - **Date range** — Two date inputs: "From" and "To".
  - **Clear filters** button.
- [ ] Filters update URL query params and re-fetch data. Use Next.js `useSearchParams` + `useRouter` for URL-synced state.

#### Table

- [ ] Implement a data table with these columns:

| Column    | Width | Content                                             |
| --------- | ----- | --------------------------------------------------- |
| Timestamp | 180px | Formatted date+time (e.g., "Feb 20, 2026, 3:45 PM") |
| User      | 150px | User name (with email tooltip)                      |
| Action    | 150px | Human-readable label (from mapping above)           |
| Entity    | 120px | Entity type                                         |
| Entity ID | 100px | Truncated ID (first 8 chars, full on hover)         |
| Summary   | flex  | Auto-generated from action + entity + key changes   |

- [ ] **Summary generation** — Helper function that produces a human-readable one-liner:
  - `MEMBER_ACTIVATED` + `CommitteeMembership` → "John Doe activated in Rochester LD 1 ED 5"
  - `MEMBER_REMOVED` + `CommitteeMembership` → "Jane Smith removed (Party Change)"
  - `PETITION_RECORDED` → "Petition outcome recorded for LD 1 ED 3 Seat 2"
  - Extract key info from `afterValue` JSON (member name from metadata, committee info from entity).
- [ ] Clickable rows to open detail view.

#### Pagination

- [ ] Use offset-based pagination (consistent with `ReportsList.tsx` pattern).
- [ ] Show page numbers with max 5 visible pages + first/last buttons.
- [ ] Default 25 rows per page. Options: 25, 50, 100.
- [ ] Show total count: "Showing 1–25 of 342 entries".

#### Detail View

- [ ] **Pattern: Slide-over drawer** (right side, 400px wide) — matches the pattern used in admin workflows.
  - Use the `Sheet` component from shadcn/ui (already used in `AdminSidebar.tsx` for mobile nav).
- [ ] Detail view contents:
  - **Header**: Action label + timestamp.
  - **User info**: Name, email, role at time of action.
  - **Entity info**: Type + full ID (copyable).
  - **Before/After diff**: Show `beforeValue` and `afterValue` as formatted JSON blocks.
    - If both exist: Side-by-side comparison (or stacked on narrow screens).
    - If only `afterValue` (creation): Show "Created" label + formatted JSON.
    - If only `beforeValue` (shouldn't happen with current design): Show "Before" label.
    - Highlight changed fields (diff the JSON keys).
  - **Metadata**: Formatted JSON block for `metadata` field (override reasons, bypassed checks, etc.).
- [ ] "Close" button (X) in drawer header.

#### Export

- [ ] Export button in filter bar area: "Export" dropdown with "CSV" and "XLSX" options.
- [ ] Export respects current active filters.
- [ ] Show loading state while export is generating.
- [ ] Download triggers browser file download via the `/api/admin/audit/export` endpoint.

### Testing

- [ ] API: Test list endpoint with each filter type individually and in combination.
- [ ] API: Test pagination (page, pageSize, total count).
- [ ] API: Test detail endpoint returns full before/after JSON.
- [ ] API: Test export endpoint generates valid CSV with correct columns.
- [ ] API: Test export row limit (10,000 cap).
- [ ] API: Test auth — non-Admin users get 403.
- [ ] UI: Test filter bar updates URL params and triggers re-fetch.
- [ ] UI: Test table renders correct columns and data.
- [ ] UI: Test detail drawer opens with correct content on row click.
- [ ] UI: Test pagination controls.
- [ ] UI: Test empty state when no audit logs match filters.

## Implementation Steps

1. **API routes** — Create list, detail, and export endpoints.
2. **Enable nav** — Set `enabled: true` in `adminNav.ts`.
3. **Page structure** — Create page.tsx + AuditTrailClient.tsx.
4. **Filter bar** — Implement with URL-synced state.
5. **Table** — Implement with columns, summary generation, and pagination.
6. **Detail drawer** — Implement Sheet-based drawer with before/after diff.
7. **Export** — Implement CSV/XLSX download.
8. **Tests**.

## Files to Create

| File                                                      | Purpose                                    |
| --------------------------------------------------------- | ------------------------------------------ |
| `apps/frontend/src/app/admin/audit/page.tsx`              | Audit trail page (server component)        |
| `apps/frontend/src/app/admin/audit/AuditTrailClient.tsx`  | Main client component with table + filters |
| `apps/frontend/src/app/admin/audit/AuditDetailDrawer.tsx` | Slide-over detail view                     |
| `apps/frontend/src/app/admin/audit/auditUtils.ts`         | Label mappings, summary generation         |
| `apps/frontend/src/app/api/admin/audit/route.ts`          | GET list endpoint                          |
| `apps/frontend/src/app/api/admin/audit/[id]/route.ts`     | GET detail endpoint                        |
| `apps/frontend/src/app/api/admin/audit/export/route.ts`   | GET export (CSV/XLSX) endpoint             |

## Files to Modify

| File                                   | Change                        |
| -------------------------------------- | ----------------------------- |
| `apps/frontend/src/config/adminNav.ts` | Enable "Audit Trail" nav item |

## Related

- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §14
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.5
- [1.5 Audit Trail Infrastructure](1.5-audit-trail-infrastructure.md)
