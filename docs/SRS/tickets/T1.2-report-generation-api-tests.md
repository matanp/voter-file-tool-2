# T1.2 Report Generation API Tests

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Testing Tier 1 §T1.2
**Effort:** 0.5–1 day
**Depends on:** Nothing (can run in parallel with Batch A)

## Summary

Extend the existing `generateReport.test.ts` with the two remaining coverage gaps identified in [TEST_REVIEW_GAPS.md](../../CODEBASE_AUDIT/TEST_REVIEW_GAPS.md). The core test suite already exists with broad coverage — this ticket adds the missing cases only.

**Important:** Read the route and the existing test file before writing new tests — the route uses gzip compression and HMAC signing (via `WEBHOOK_SECRET`) to authenticate requests to the PDF server, and the status flow is `PENDING → PROCESSING` (success) / `PENDING → FAILED` (error), not a simple pass-through.

## What's Already Covered (do not duplicate)

The existing file `apps/frontend/src/__tests__/api/generateReport.test.ts` covers:
- Auth (401/403)
- Success path: report updated to `PROCESSING`, `reportId` + `jobsAhead` returned
- Multiple report types: `ldCommittees`, `absenteeReport`
- 400 for invalid request body
- 500 when `WEBHOOK_SECRET` env var is missing
- 500 + `FAILED` when PDF API returns `response.ok=false`
- 500 + `FAILED` when PDF API returns `ok=true` but `success=false`

## Acceptance Criteria (remaining gaps)

### Gap 1 — Session with missing `user.id`

- [x] Session exists but `session.user.id` is falsy (empty string) → 401 (withPrivilege guards before handler)
- [x] Verify no report record is created and no PDF API call is made

### Gap 2 — HMAC/gzip signing correctness (low severity)

- [x] Verify the request sent to the PDF server includes the `x-webhook-signature` header
- [x] Verify the request body is gzip-compressed (Content-Encoding or body is a Buffer, not plain JSON)
- [x] Note: full cryptographic HMAC verification may be better suited to integration tests; unit test asserts the header is present, non-empty, and matches `sha256=<hex>` with gzip magic bytes (0x1f 0x8b) in body

## Actual Status Flow (for reference)

```
Request received
  → Report created: status = PENDING
  → PDF API called (gzipped body, HMAC-signed header)
    → PDF API success (ok=true, success=true): status = PROCESSING  ← success terminal
    → PDF API failure (ok=false OR success=false): status = FAILED   ← error terminal
    → PDF API unreachable (fetch throws): status = FAILED
  → Exception during any step (reportId known): status = FAILED
```

## Implementation Notes

- **Existing test file to extend:** `apps/frontend/src/__tests__/api/generateReport.test.ts` — add new `it(...)` blocks; do not restructure existing tests
- **Route file:** `apps/frontend/src/app/api/generateReport/route.ts`
- **Pattern:** follow existing test patterns in the file — uses `createMockSession()`, `jest.mock` for Prisma, `jest.spyOn(global, 'fetch')`
- **`WEBHOOK_SECRET`:** set `process.env.WEBHOOK_SECRET = "test-secret"` in a `beforeEach` for Gap 2 tests; restore in `afterEach` (use try/finally per existing pattern)
- **Do not test:** report content/formatting, gzip decompression correctness, cryptographic signature strength

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Testing Tier 1 §T1.2
- [TEST_REVIEW_GAPS.md](../../CODEBASE_AUDIT/TEST_REVIEW_GAPS.md) — source of the two remaining gaps
- [T1.1 handleRequest Route Tests](T1.1-handleRequest-route-tests.md) — example of existing route test pattern
