# 3.2 Sign-In Sheet Report UI

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.2
**Effort:** 2–3 days
**Depends on:** [3.0 Report-server Migration](3.0-report-server-committee-membership-migration.md), [3.0a Report Audit](3.0a-report-audit-committee-membership.md), [3.1 Jurisdiction Assignment UI](3.1-jurisdiction-assignment-ui.md)

## Summary

Add sign-in-sheet report generation — both the report-server PDF renderer and the frontend report UI. This is the first new report type added after the initial 5 and establishes the pattern for 3.3 and 3.4. The **frontend form** (scope selector "My Jurisdictions" / "Countywide", jurisdiction dropdowns, Leader scoping) requires [3.1](3.1-jurisdiction-assignment-ui.md) (UserJurisdiction and `/api/user/jurisdictions`).

## Current State

- **Report picker** — `GenerateReportGrid.tsx` already has placeholder cards for "Sign-In Sheet" and other future reports, rendered with a "Coming soon" badge and disabled state.
- **Report pipeline** — The existing flow is: frontend form → POST `/api/generateReport` → gzip payload to report-server `/start-job` → async.queue processes → callback webhook → Ably status update to client.
- **Report types** — Registered in `packages/shared-validators/src/schemas/report.ts` as a Zod discriminated union and in `reportTypeMapping.ts`.
- **PDF rendering** — `CommitteeReport.tsx` renders committee PDFs using React → `renderToStaticMarkup()` → HTML → Puppeteer PDF. Same pattern applies here.

## Acceptance Criteria

### Report-Server — `signInSheet` Report Type

#### Schema Registration
- [x] Add `signInSheetReportSchema` to `packages/shared-validators/src/schemas/report.ts`:
  ```ts
  const signInSheetReportSchema = z.object({
    type: z.literal('signInSheet'),
    name: z.string(),
    format: z.literal('pdf'),  // sign-in sheets are PDF-only
    reportAuthor: z.string(),
    jobId: z.string().cuid(),
    scope: z.enum(['jurisdiction', 'countywide']),
    cityTown: z.string().optional(),       // required if scope=jurisdiction
    legDistrict: z.number().optional(),    // optional, for Rochester
    meetingDate: z.string().optional(),    // ISO date string, printed on sheet header
  });
  ```
  - **Validation**: Add a `.refine()` (or equivalent) so that when `scope === 'jurisdiction'`, `cityTown` is required; otherwise runtime and types can diverge. The frontend form must enforce the same rule (disable submit or show validation error when scope is jurisdiction and cityTown is empty). *(Runtime validation in processJob; Zod refine incompatible with discriminated union.)*
- [x] Add to `generateReportSchema` discriminated union.
- [x] Add to `REPORT_TYPE_MAPPINGS` in `reportTypeMapping.ts`:
  ```ts
  signInSheet: { databaseValue: 'SignInSheet', filename: 'signInSheet' }
  ```

#### Data Fetching
- [x] Create `fetchSignInSheetData()` in `apps/report-server/src/committeeMappingHelpers.ts`:
  - Query `CommitteeList` with `memberships` (`status=ACTIVE`, active term) and `voterRecord`.
  - If `scope=jurisdiction`: filter by `cityTown` and optional `legDistrict`.
  - If `scope=countywide`: fetch all committees for active term.
  - Return data sorted by cityTown → legDistrict → electionDistrict.

#### PDF Component
- [x] Create `apps/report-server/src/components/SignInSheet.tsx`:
  - **Page layout**: Portrait 8.5"×11" (standard letter).
  - **Header per committee**: "Sign-In Sheet — [cityTown] LD [legDistrict] ED [electionDistrict]", optional meeting date.
  - **Table columns**: #, Name, Address, Signature, Notes.
  - **Rows**: One row per active member (pre-filled name + address from voter record), plus 3–5 blank rows for walk-ins.
  - **Page breaks**: One committee per page (or paginate if > 25 members).
  - **Footer**: Page number, generation date, report author.
- [x] Follow the same React → HTML → PDF pattern used by `CommitteeReport.tsx` and `DesignatingPetition.tsx`.

#### Handler
- [x] Add `signInSheet` case to `processJob()` in `apps/report-server/src/index.ts`:
  ```ts
  } else if (type === 'signInSheet') {
    const data = await fetchSignInSheetData(scope, cityTown, legDistrict);
    const html = generateReportHTML(<SignInSheet data={data} meetingDate={meetingDate} />);
    await generatePDFAndUpload(html, fileName);
  }
  ```

### Frontend — Report UI

#### Report Picker
- [x] Update `apps/frontend/src/components/reports/GenerateReportGrid.tsx`:
  - Change "Sign-In Sheet" card from disabled/"Coming soon" to enabled with a link to `/sign-in-sheet-reports`.
  - Description: "Generate sign-in sheets for committee meetings with member names and signature lines."

#### Report Form Page
- [x] Create `apps/frontend/src/app/sign-in-sheet-reports/page.tsx` — server component with auth check.
- [x] Create `apps/frontend/src/app/sign-in-sheet-reports/SignInSheetForm.tsx` — client component:
  - **Report name** — Text input with auto-generated default: "Sign-In Sheet - [date]".
  - **Scope selector** — Radio group: "My Jurisdictions" (Leader default) / "Countywide" (Admin only).
    - Leader users: "Countywide" is hidden or disabled.
    - Admin users: Both options available, default "Countywide".
  - **Jurisdiction filter** (when scope = "My Jurisdictions" or admin selects jurisdiction):
    - cityTown `ComboboxDropdown` — For leaders, filtered to their jurisdictions. For admins, all cities.
    - legDistrict `ComboboxDropdown` — Conditional on cityTown selection.
  - **Meeting date** — Optional date picker. Printed on the sheet header if provided.
  - **Generate button** — Submits to `/api/generateReport` with `type: 'signInSheet'`.
- [x] Validation:
  - If scope is `jurisdiction`, `cityTown` is required.
  - Report name is required, max 100 chars.
- [x] Empty states:
  - "No committees found for the selected jurisdiction" — when cityTown/legDistrict combo has zero committees.
- [x] After submission, show `ReportStatusTracker` component for real-time job status via Ably.

#### API Route
- [x] Update `/api/generateReport` handler to accept `type: 'signInSheet'` and forward scope/jurisdiction params.
- [x] Apply jurisdiction scoping: if Leader, verify their `UserJurisdiction` includes the requested cityTown/legDistrict.

### Testing
- [x] Report-server: Test `fetchSignInSheetData()` returns committees filtered by scope/jurisdiction.
- [x] Report-server: Test `SignInSheet.tsx` renders correct HTML structure (member rows + blank rows + header).
- [x] Report-server: Test `signInSheet` handler in `processJob()` produces a PDF file.
- [x] Frontend: Test form validation (scope + cityTown required for jurisdiction scope).
- [x] Frontend: Test Leader cannot select "Countywide" scope.

## Implementation Steps

1. **Schema** — Add `signInSheetReportSchema` and `REPORT_TYPE_MAPPINGS` entry.
2. **Data fetching** — Add `fetchSignInSheetData()` to report-server.
3. **PDF component** — Create `SignInSheet.tsx` with the layout spec.
4. **Handler** — Add `signInSheet` case to `processJob()`.
5. **Frontend page** — Create form page at `/sign-in-sheet-reports` with scope/jurisdiction/date params.
6. **Report picker** — Enable the card in `GenerateReportGrid.tsx`.
7. **API** — Update generateReport handler and add scope enforcement.
8. **Tests** — Report-server + frontend tests.

## Files to Create

| File | Purpose |
|------|---------|
| `apps/report-server/src/components/SignInSheet.tsx` | Sign-in sheet PDF React component |
| `apps/frontend/src/app/sign-in-sheet-reports/page.tsx` | Sign-in sheet report page |
| `apps/frontend/src/app/sign-in-sheet-reports/SignInSheetForm.tsx` | Form with scope/jurisdiction/date params |

## Files to Modify

| File | Change |
|------|--------|
| `packages/shared-validators/src/schemas/report.ts` | Add `signInSheetReportSchema` to discriminated union |
| `packages/shared-validators/src/reportTypeMapping.ts` | Add `signInSheet` mapping |
| `apps/report-server/src/index.ts` | Add `signInSheet` handler in `processJob()` |
| `apps/report-server/src/committeeMappingHelpers.ts` | Add `fetchSignInSheetData()` |
| `apps/frontend/src/components/reports/GenerateReportGrid.tsx` | Enable sign-in sheet card |
| `apps/frontend/src/components/reports/reportUtils.ts` | Add `signInSheet` to `formatReportType()` |

## Related

- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §13
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.2
- [3.3 Designation Weight Summary Report](3.3-designation-weight-summary-report-ui.md)
- [3.4 Vacancy, Changes, and Petition Outcomes Reports](3.4-vacancy-changes-petition-reports-ui.md)
