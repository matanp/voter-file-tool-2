# 3.4 Vacancy, Changes, and Petition Outcomes Reports UI

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.4
**Effort:** 2–3 days
**Depends on:** [2.6 Petition + Primary Outcome Tracking](2.6-petition-primary-outcome-tracking.md), [3.2 Sign-In Sheet Report UI](3.2-sign-in-sheet-report-ui.md)

**Migration note:** Schema changes for `ReportType` enum are in place; no migration file in this worktree (to avoid conflicts with 3.3). After merging 3.3 into this branch, run `pnpm --filter voter-file-tool exec prisma migrate dev --name add_vacancy_changes_petition_report_types` to create the migration.

## Summary

Add the final 3 report types: Vacancy Report, Changes Report, and Petition Outcomes Report. These reports share a common form pattern (established in 3.2/3.3) with scope + date range + format parameters. This ticket also produces the consolidated report parameter matrix for all report types.

## Current State

- **Report pipeline** and **form pattern** established by 3.2 (Sign-In Sheet) and 3.3 (Weight Summary).
- **Data sources** already exist:
  - Vacancy: `Seat` model + `CommitteeMembership` (status=ACTIVE) — compare `maxSeatsPerLted` to active member count.
  - Changes: `CommitteeMembership` status transition timestamps (`activatedAt`, `resignedAt`, `removedAt`, `confirmedAt`).
  - Petition Outcomes: `CommitteeMembership` with `membershipType=PETITIONED` and statuses `ACTIVE`, `PETITIONED_LOST`, `PETITIONED_TIE`.
- **Report picker** (`GenerateReportGrid.tsx`) has placeholder cards for all 3 with "Coming soon" badges.

## Acceptance Criteria

### A. Vacancy Report

#### Schema
- [ ] Add `vacancyReportSchema` to `packages/shared-validators/src/schemas/report.ts`:
  ```ts
  const vacancyReportSchema = z.object({
    type: z.literal('vacancyReport'),
    name: z.string(),
    format: z.enum(['pdf', 'xlsx']),
    reportAuthor: z.string(),
    jobId: z.string().cuid(),
    scope: z.enum(['jurisdiction', 'countywide']),
    cityTown: z.string().optional(),
    legDistrict: z.number().optional(),
    vacancyFilter: z.enum(['all', 'vacantOnly']).default('vacantOnly'),
  });
  ```
- [ ] Add to union and `REPORT_TYPE_MAPPINGS`: `vacancyReport: { databaseValue: 'VacancyReport', filename: 'vacancyReport' }`.

#### Data Fetching
- [ ] Create `fetchVacancyData()` in `committeeMappingHelpers.ts`:
  - For each committee (scoped by jurisdiction or countywide):
    - Fetch `maxSeatsPerLted`, count of ACTIVE memberships, count of petitioned seats (`isPetitioned=true`), count of vacant petitioned seats.
    - Return: `{ cityTown, legDistrict, electionDistrict, totalSeats, filledSeats, vacantSeats, petitionedSeats, vacantPetitionedSeats, nonPetitionedSeats }`.
  - If `vacancyFilter=vacantOnly`: filter to committees with `vacantSeats > 0`.
  - Sort by cityTown → legDistrict → electionDistrict.

#### PDF/XLSX Output
- [ ] **PDF** (`VacancyReport.tsx`): Landscape table grouped by city/LD.
  - Columns: ED, Total Seats, Filled, Vacant, Petitioned (Filled/Vacant), Non-Petitioned.
  - Subtotal per LD group. Grand total at bottom.
- [ ] **XLSX**: Single "Vacancy Report" worksheet with same columns + subtotal rows.

### B. Changes Report

#### Schema
- [ ] Add `changesReportSchema`:
  ```ts
  const changesReportSchema = z.object({
    type: z.literal('changesReport'),
    name: z.string(),
    format: z.enum(['pdf', 'xlsx']),
    reportAuthor: z.string(),
    jobId: z.string().cuid(),
    scope: z.enum(['jurisdiction', 'countywide']),
    cityTown: z.string().optional(),
    legDistrict: z.number().optional(),
    dateFrom: z.string(),  // ISO date — required
    dateTo: z.string(),    // ISO date — required
  });
  ```
- [ ] Add to union and mappings: `changesReport: { databaseValue: 'ChangesReport', filename: 'changesReport' }`.

#### Data Fetching
- [ ] Create `fetchChangesData()` in `committeeMappingHelpers.ts`:
  - Query `CommitteeMembership` where any lifecycle timestamp falls within `[dateFrom, dateTo]`:
    - `activatedAt` (new members)
    - `resignedAt` (resignations)
    - `removedAt` (removals)
    - `confirmedAt` (confirmations)
  - Join with `voterRecord` for name/address, `committeeList` for LTED info.
  - Return: `{ memberName, cityTown, legDistrict, electionDistrict, changeType, changeDate, details }`.
  - `changeType`: "Added" / "Resigned" / "Removed" / "Confirmed" / "Petition Won" / "Petition Lost".
  - `details`: reason for removal, resignation method, petition vote count — depending on change type.
  - Sort by changeDate descending.

#### PDF/XLSX Output
- [ ] **PDF** (`ChangesReport.tsx`): Portrait or landscape table.
  - Header: "Committee Changes — [dateFrom] to [dateTo]".
  - Columns: Date, Member Name, City/Town, LD, ED, Change Type, Details.
  - Group by change type or by date (TBD — date grouping is more useful for audit).
- [ ] **XLSX**: Single "Changes" worksheet with same columns + filters.

### C. Petition Outcomes Report

#### Schema
- [ ] Add `petitionOutcomesReportSchema`:
  ```ts
  const petitionOutcomesReportSchema = z.object({
    type: z.literal('petitionOutcomesReport'),
    name: z.string(),
    format: z.enum(['pdf', 'xlsx']),
    reportAuthor: z.string(),
    jobId: z.string().cuid(),
    scope: z.enum(['jurisdiction', 'countywide']),
    cityTown: z.string().optional(),
    legDistrict: z.number().optional(),
  });
  ```
- [ ] Add to union and mappings: `petitionOutcomesReport: { databaseValue: 'PetitionOutcomesReport', filename: 'petitionOutcomesReport' }`.

#### Data Fetching
- [ ] Create `fetchPetitionOutcomesData()` in `committeeMappingHelpers.ts`:
  - Query `CommitteeMembership` where `membershipType=PETITIONED` and active term.
  - Group by committee (cityTown/legDistrict/electionDistrict) → seat number.
  - For each seat: list candidates with `{ name, voteCount, outcome, primaryDate }`.
  - Sort by cityTown → legDistrict → electionDistrict → seatNumber.

#### MembershipStatus → Display Label Mapping

The database stores petition results as `MembershipStatus` enum values. The report must map these to human-readable outcome labels. Use this canonical mapping in both the data-fetching layer (report-server) and PDF/XLSX renderers:

| `MembershipStatus` | Display Label | Notes |
|---|---|---|
| `ACTIVE` (where `membershipType=PETITIONED`) | **"Won"** | Winner of primary; status transitions to ACTIVE on recording |
| `PETITIONED_LOST` | **"Lost"** | Lost primary; seatNumber is null |
| `PETITIONED_TIE` | **"Tie"** | Tie; seat remains vacant |
| `ACTIVE` (where `membershipType=PETITIONED` and outcome was unopposed) | **"Unopposed"** | Distinguish from contested win via `petitionVoteCount`: if null/0 and no other candidates for the same `petitionSeatNumber`, display "Unopposed"; otherwise "Won" |

Implementation note: "Won" vs "Unopposed" cannot be determined from `MembershipStatus` alone — both are `ACTIVE` with `membershipType=PETITIONED`. To distinguish:
- Query all candidates for the same `(committeeListId, termId, petitionSeatNumber)`.
- If only one candidate exists for that seat → "Unopposed".
- If multiple candidates exist → winner is "Won", others are "Lost" or "Tie".

Define this mapping as a shared helper (e.g. `getPetitionOutcomeLabel(membership, seatCandidateCount)`) in `committeeMappingHelpers.ts` so both PDF and XLSX renderers use the same logic.

#### PDF/XLSX Output
- [ ] **PDF** (`PetitionOutcomesReport.tsx`): Landscape table grouped by committee.
  - Group header: "City/Town: [name], LD [X], ED [Y]".
  - Columns: Seat #, Candidate Name, Vote Count, Outcome, Primary Date.
  - Color coding: "Won"/"Unopposed" rows highlighted (green background), "Tie" in amber, "Lost" in default.
- [ ] **XLSX**: Single "Petition Outcomes" worksheet with same columns.

### D. Shared Frontend Pattern

All 3 reports follow the same frontend form pattern established in 3.2/3.3:

- [ ] Create form pages under:
  - `apps/frontend/src/app/vacancy-reports/` (page.tsx + VacancyReportForm.tsx)
  - `apps/frontend/src/app/changes-reports/` (page.tsx + ChangesReportForm.tsx)
  - `apps/frontend/src/app/petition-outcomes-reports/` (page.tsx + PetitionOutcomesReportForm.tsx)
- [ ] Each form has: name, format (PDF/XLSX), scope (jurisdiction/countywide), jurisdiction filters, type-specific params.
- [ ] Enable all 3 cards in `GenerateReportGrid.tsx`.
- [ ] Update `formatReportType()` in `reportUtils.ts` for all 3 types.

#### Type-Specific Form Parameters

| Report | Extra Params | Default |
|--------|-------------|---------|
| Vacancy | `vacancyFilter`: "Show all" / "Vacant only" (radio) | Vacant only |
| Changes | `dateFrom`, `dateTo`: date range picker (both required) | Last 30 days |
| Petition Outcomes | None beyond scope | — |

### E. Consolidated Report Parameter Matrix

- [ ] Publish a report parameter matrix as a table in this ticket and/or in `docs/SRS/` covering ALL report types:

| Report Type | Formats | Scope Options | Extra Params | Leader Access | Admin Access |
|---|---|---|---|---|---|
| Committee Roster (`ldCommittees`) | PDF, XLSX | Countywide | Field selection, column order | No | Yes |
| Voter List | XLSX | N/A (search-based) | Search query, field selection | No | Yes |
| Designated Petition | PDF | N/A (payload-based) | Candidates, party, appointments | Yes | Yes |
| Absentee Report | XLSX | N/A (CSV-based) | CSV file | No | Yes |
| Sign-In Sheet | PDF | Jurisdiction, Countywide | Meeting date (optional) | Jurisdiction only | Both |
| Designation Weight Summary | PDF, XLSX | Jurisdiction, Countywide | — | Jurisdiction only | Both |
| Vacancy Report | PDF, XLSX | Jurisdiction, Countywide | Vacancy filter | Jurisdiction only | Both |
| Changes Report | PDF, XLSX | Jurisdiction, Countywide | Date range (required) | Jurisdiction only | Both |
| Petition Outcomes Report | PDF, XLSX | Jurisdiction, Countywide | — | Jurisdiction only | Both |

### Testing
- [ ] Report-server: Test each `fetch*Data()` function with scope filtering and edge cases (empty results, no petitioned seats).
- [ ] Report-server: Test each PDF component renders correct structure.
- [ ] Report-server: Test each handler in `processJob()`.
- [ ] Frontend: Test form validation for each report type.
- [ ] Frontend: Test Leader scope restrictions.
- [ ] Integration: Generate one report of each type and verify output.

## Implementation Steps

1. **Schemas** — Add all 3 report schemas + type mappings in shared-validators.
2. **Data fetching** — Add `fetchVacancyData()`, `fetchChangesData()`, `fetchPetitionOutcomesData()` to report-server.
3. **PDF components** — Create `VacancyReport.tsx`, `ChangesReport.tsx`, `PetitionOutcomesReport.tsx`.
4. **XLSX paths** — Add XLSX generation for each report type.
5. **Handlers** — Add 3 cases to `processJob()`.
6. **Frontend forms** — Create 3 form pages following the 3.2/3.3 pattern.
7. **Report picker** — Enable all 3 cards.
8. **Parameter matrix** — Document the full matrix.
9. **Tests**.

## Files to Create

| File | Purpose |
|------|---------|
| `apps/report-server/src/components/VacancyReport.tsx` | Vacancy PDF component |
| `apps/report-server/src/components/ChangesReport.tsx` | Changes PDF component |
| `apps/report-server/src/components/PetitionOutcomesReport.tsx` | Petition outcomes PDF component |
| `apps/frontend/src/app/vacancy-reports/page.tsx` | Vacancy report page |
| `apps/frontend/src/app/vacancy-reports/VacancyReportForm.tsx` | Vacancy form |
| `apps/frontend/src/app/changes-reports/page.tsx` | Changes report page |
| `apps/frontend/src/app/changes-reports/ChangesReportForm.tsx` | Changes form |
| `apps/frontend/src/app/petition-outcomes-reports/page.tsx` | Petition outcomes report page |
| `apps/frontend/src/app/petition-outcomes-reports/PetitionOutcomesReportForm.tsx` | Petition outcomes form |

## Files to Modify

| File | Change |
|------|--------|
| `packages/shared-validators/src/schemas/report.ts` | Add 3 schemas + union members |
| `packages/shared-validators/src/reportTypeMapping.ts` | Add 3 mappings |
| `apps/report-server/src/index.ts` | Add 3 handlers in `processJob()` |
| `apps/report-server/src/committeeMappingHelpers.ts` | Add 3 data-fetching functions |
| `apps/frontend/src/components/reports/GenerateReportGrid.tsx` | Enable 3 cards |
| `apps/frontend/src/components/reports/reportUtils.ts` | Add 3 types to `formatReportType()` |

## Related

- [SRS_UI_PLANNING_GAPS.md](../SRS_UI_PLANNING_GAPS.md) §13
- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.4
- [2.6 Petition + Primary Outcome Tracking](2.6-petition-primary-outcome-tracking.md)
- [3.2 Sign-In Sheet Report UI](3.2-sign-in-sheet-report-ui.md)
- [3.3 Designation Weight Summary Report](3.3-designation-weight-summary-report-ui.md)
