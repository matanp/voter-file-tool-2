# 1.5c Audit Log Route Wiring

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §1.5
**Effort:** 1–2 days
**Depends on:** [1.5b Audit Log Utility & Immutability](1.5b-audit-log-utility-and-immutability.md)

## Summary

Wire `logAuditEvent` calls into all existing committee mutation routes. Each call fires after the primary DB operation succeeds and captures before/after snapshots. Write an integration test for at least one wired route.

## Acceptance Criteria

### Route Wiring

All `logAuditEvent` calls are placed **after** the primary DB operation succeeds and **before** the response is returned. Audit failures must not affect the response (the utility already swallows errors).

#### `committee/add` (`apps/frontend/src/app/api/committee/add/route.ts`)

- [x] Log `MEMBER_ACTIVATED` after creating or re-activating a `CommitteeMembership`
- [x] `before`: `null` for new membership; `{ status: existingMembership.status }` for re-activation
- [x] `after`: `{ status: "ACTIVE" }`
- [x] `entityType`: `"CommitteeMembership"`
- [x] `entityId`: the membership's `id`
- [x] `userId`: `session.user.id`
- [x] `userRole`: `session.user.privilegeLevel`
- [x] Do **not** log for idempotent no-ops (member already ACTIVE — early return at line 64)

#### `committee/remove` (`apps/frontend/src/app/api/committee/remove/route.ts`)

- [x] Log `MEMBER_REMOVED` after updating the membership to `REMOVED`
- [x] `before`: `{ status: "ACTIVE" }` (the guard at line 70 ensures only ACTIVE members are removed)
- [x] `after`: `{ status: "REMOVED", removalReason, removalNotes }` (include reason/notes if provided)
- [x] `entityType`: `"CommitteeMembership"`
- [x] `entityId`: `membership.id`

#### `committee/handleRequest` — accept path (`apps/frontend/src/app/api/committee/handleRequest/route.ts`)

- [x] Log `MEMBER_ACTIVATED` after transitioning `SUBMITTED → ACTIVE`
- [x] `before`: `{ status: "SUBMITTED" }`
- [x] `after`: `{ status: "ACTIVE", membershipType: "APPOINTED" }`
- [x] `entityType`: `"CommitteeMembership"`
- [x] `entityId`: `membershipId`

#### `committee/handleRequest` — reject path

- [x] Log `MEMBER_REJECTED` after transitioning `SUBMITTED → REJECTED`
- [x] `before`: `{ status: "SUBMITTED" }`
- [x] `after`: `{ status: "REJECTED" }`
- [x] `entityType`: `"CommitteeMembership"`
- [x] `entityId`: `membershipId`

#### `committee/handleRequest` — capacity-reject path

- [x] Log `MEMBER_REJECTED` after capacity-driven rejection (line 68–79)
- [x] `before`: `{ status: "SUBMITTED" }`
- [x] `after`: `{ status: "REJECTED", rejectionNote: "Committee already full" }`
- [x] `metadata`: `{ reason: "capacity" }`

#### `committee/requestAdd` (`apps/frontend/src/app/api/committee/requestAdd/route.ts`)

- [x] Log `MEMBER_SUBMITTED` after creating the `CommitteeMembership` with `SUBMITTED` status
- [x] `before`: `null`
- [x] `after`: `{ status: "SUBMITTED" }`
- [x] `entityType`: `"CommitteeMembership"`
- [x] `entityId`: the created membership's `id` (capture the return value from `prisma.committeeMembership.create`)
- [x] `userId`: `session.user.id`
- [x] `userRole`: `session.user.privilegeLevel`
- [x] Do **not** log for idempotent no-ops (already SUBMITTED — early return at line 124)

### Session Access Pattern

All routes currently receive `session` (or `_session`) typed as `Session` via `withPrivilege`. To pass `userRole`:

- [x] Change `_session` to `session` in routes that currently discard it (`add/route.ts`, `remove/route.ts`, `handleRequest/route.ts`)
- [x] Access `session.user.privilegeLevel` — the `withPrivilege` guard has already verified it exists (line 41–51 of `withPrivilege.ts`)
- [x] Cast or fallback: `session.user.privilegeLevel as PrivilegeLevel` (the guard guarantees it's set for non-`"Authenticated"` routes)

### Membership ID Capture

Two routes currently do not capture the created membership's `id`:

- [x] `committee/add` — when creating a new membership (`prisma.committeeMembership.create`), capture the return value to get `membership.id` for the audit log. When re-activating, `existingMembership.id` is already available.
- [x] `committee/requestAdd` — capture the return value from `prisma.committeeMembership.create` to get the `id` for the audit log.

### Testing

- [x] Integration test in `apps/frontend/src/__tests__/api/committee/add.test.ts` (extend existing file):
  - After a successful add, verify `prismaMock.auditLog.create` was called with:
    - `userId` matching the session user
    - `action: "MEMBER_ACTIVATED"`
    - `entityType: "CommitteeMembership"`
    - `entityId` matching the created membership
    - `afterValue` containing `{ status: "ACTIVE" }`
  - After an idempotent no-op (already ACTIVE), verify `prismaMock.auditLog.create` was **not** called
  - After an audit failure (mock `auditLog.create` to reject), verify the route still returns success (audit does not block)

- [x] Integration test in `apps/frontend/src/__tests__/api/committee/handleRequest.test.ts` (extend existing file):
  - After accept, verify `MEMBER_ACTIVATED` audit log created
  - After reject, verify `MEMBER_REJECTED` audit log created
  - After capacity-reject, verify `MEMBER_REJECTED` audit log created with `metadata.reason: "capacity"`

## Implementation Notes

- **Why after the DB operation:** Audit calls fire after the primary mutation succeeds. If the mutation fails (e.g. capacity, already-in-another-committee), no audit log is created for the attempt — only for successful state changes. The exceptions are capacity-rejection in `handleRequest` where the membership status is actually changed to REJECTED in the database.
- **`requestAdd` special case:** This route uses `PrivilegeLevel.RequestAccess` (not Admin). The `session.user.privilegeLevel` will be `RequestAccess` or `Leader` — this is correct and expected. Leaders submitting candidates are logged at their actual privilege level.
- **Test mock setup:** The mock Prisma client (`prismaMock`) needs an `auditLog` model mock. If it doesn't exist yet, add it to `__tests__/utils/mocks.ts` following the existing pattern (e.g. `getMembershipMock`).
- **Override logging (future):** When ticket 2.1 (Eligibility Validation) adds `forceAdd`, the audit log `metadata` should include `bypassedReasons` and `overrideReason`. That wiring is 2.1's responsibility — this ticket establishes the infrastructure.

## Related

- [1.5 Audit Trail Infrastructure](1.5-audit-trail-infrastructure.md) — parent ticket
- [1.5a Audit Log Schema & SYSTEM User Seed](1.5a-audit-log-schema-and-seed.md) — schema prerequisite
- [1.5b Audit Log Utility & Immutability](1.5b-audit-log-utility-and-immutability.md) — utility prerequisite
- [2.1 Eligibility Validation](2.1-eligibility-validation.md) — will extend audit metadata with override/bypass logging
- [2.3 Resignation Workflow](2.3-resignation-workflow.md) — will add `MEMBER_RESIGNED` logging using this infrastructure
- [3.5 Audit Trail UI](../SRS_IMPLEMENTATION_ROADMAP.md) — admin UI for viewing audit log (future)
