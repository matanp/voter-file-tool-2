# 1.R.14 handleRequest Capacity Check for Replacement (P2)

**Status:** Done
**Priority:** P2 — Medium
**Effort:** 0.5 day
**Depends on:** [1.2 CommitteeMembership Model](1.2-committee-membership-model.md), [1.4 Seat Model](1.4-seat-model.md)

## Summary

The capacity check in `handleRequest` (accept) rejects when `activeCount >= config.maxSeatsPerLted` without accounting for a pending replacement (`removeMemberId`). Valid replacement requests can be incorrectly blocked. This ticket computes an effective active count so replacements are allowed when the member being removed frees a seat.

## Acceptance Criteria

- [x] Before the capacity check, compute effective active count: `effectiveActiveCount = activeCount - (replacementTarget ? 1 : 0)`.
- [x] Validate `removeMemberId`: same committee (via composite unique key), ACTIVE status, not the incoming membership.
- [x] Use the effective count for the capacity comparison against `maxSeatsPerLted`.
- [x] Add test for accept-with-replacement when at capacity (4/4 active → replacement frees seat → accepted).

## Implementation Notes

- **Files:** [apps/frontend/src/app/api/committee/handleRequest/route.ts](apps/frontend/src/app/api/committee/handleRequest/route.ts), [apps/frontend/src/__tests__/api/committee/handleRequest.test.ts](apps/frontend/src/__tests__/api/committee/handleRequest.test.ts).
- Replacement target validation and `effectiveActiveCount` computation are now performed before the capacity check. The replacement target is looked up early via composite unique key (`voterRecordId_committeeListId_termId`) ensuring same-committee constraint. Removal of the target still happens after the capacity check, preserving the original transaction ordering.

## Related

- [FINDINGS_AND_RESOLUTION_REGISTER.md](../FINDINGS_AND_RESOLUTION_REGISTER.md) (Finding 9)
