# 3.0a Audit and Update All Reports for CommitteeMembership

**Status:** Done (audit completed with 3.0 implementation)
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.0a
**Effort:** 0.5–1 day
**Depends on:** [3.0 Report-server Migration](3.0-report-server-committee-membership-migration.md)

## Summary

Run a report-by-report audit to ensure no report path depends on legacy committee-membership sources after 3.0. Confirm migration status for each report type and capture any required follow-up work.

## Current State — Report Type Inventory

The report-server dispatches 5 report types in `apps/report-server/src/index.ts` `processJob()` (lines ~189–302):

| Report Type | Handler Location | Uses Committee Data? | Expected Status |
|---|---|---|---|
| `ldCommittees` | index.ts:193–212 → `committeeMappingHelpers.ts` | **Yes** — fetches memberships | Migrated in 3.0 |
| `designatedPetition` | index.ts:236–258 → `DesignatingPetition.tsx` | **No** — uses payload candidates/party directly | No migration needed |
| `voterList` | index.ts:213–235 → `xlsxGenerator.ts` | **No** — uses search query → VoterRecord[] | No migration needed |
| `absenteeReport` | index.ts:259–264 → `reportProcessors/absenteeReportProcessor.ts` | **No** — loads CSV from R2, calculates stats | No migration needed |
| `voterImport` | index.ts:265–299 → `reportProcessors/voterImportProcessor.ts` | **No** — streams file from R2, processes voter records | No migration needed |

**Key finding from Roadmap §3.0a:** Only `ldCommittees` uses committee membership data. The other 4 report types do NOT reference committee membership at all.

## Acceptance Criteria

### Per-Report Audit Checklist
- [x] **`ldCommittees`** — Migrated in 3.0. Verified:
  - `fetchCommitteeData()` uses `memberships` with `status=ACTIVE`, termId, voterRecord include
  - `mapCommitteesToReportShape()` and `CommitteeReport.tsx` receive correct shape
  - `generateUnifiedXLSXAndUpload()` with `dataType: 'ldCommittees'` works with new shape
  - No `committeeMemberList` in report-server or shared-validators source
- [x] **`designatedPetition`** — No committee membership dependency. Uses request payload only.
- [x] **`voterList`** — No committee membership dependency. Direct VoterRecord query via searchQuery.
- [x] **`absenteeReport`** — No committee membership dependency. CSV-based pipeline from R2.
- [x] **`voterImport`** — No committee membership dependency. Voter file processing from R2 only.

### Codebase-Wide Verification
- [x] `grep committeeMemberList` in `apps/report-server/` — zero results.
- [x] `grep committeeMemberList` in `packages/shared-validators/src/` — zero results.
- [x] `report.ts` `generateReportSchema` / `enrichedReportDataSchema` — no `committeeMemberList`.
- [x] `reportTypeMapping.ts` — clean.

### Test Coverage
- [x] `committeeMappingHelpers.test.ts` covers fetchCommitteeData, mapCommitteesToReportShape, empty-committee case.
- [x] No additional smoke tests required for other report types (no committee dependency).

### Audit Record
- [x] All five report types audited; only `ldCommittees` used committee data; migration and type cleanup complete. No follow-up sub-tickets.

## Implementation Steps

1. **Read each handler** — For each of the 5 `processJob()` branches in `index.ts`, trace the data flow to confirm what data sources are used.
2. **Grep for legacy references** — Search report-server and shared-validators for `committeeMemberList`, `committeeMember`, or other legacy patterns.
3. **Document findings** — Fill in the checklist above with pass/fail and notes.
4. **Fix any issues** — If a reference is found, update the code and add a test.
5. **Close ticket** — Record the audit outcome directly in this ticket file.

## Files to Audit

| File | What to Check |
|------|---------------|
| `apps/report-server/src/index.ts` | All 5 handler branches in `processJob()` |
| `apps/report-server/src/committeeMappingHelpers.ts` | `fetchCommitteeData()`, `mapCommitteesToReportShape()`, types |
| `apps/report-server/src/components/CommitteeReport.tsx` | Input types, no direct Prisma calls |
| `apps/report-server/src/components/DesignatingPetition.tsx` | Confirm payload-only, no committee queries |
| `apps/report-server/src/xlsxGenerator.ts` | Both `ldCommittees` and `voterList` paths |
| `apps/report-server/src/reportProcessors/absenteeReportProcessor.ts` | CSV-only pipeline |
| `apps/report-server/src/reportProcessors/voterImportProcessor.ts` | File-processing pipeline |
| `apps/report-server/src/utils.ts` | `transformToCommitteeMemberFormat()` helper |
| `packages/shared-validators/src/schemas/report.ts` | Zod schemas for all report types |
| `packages/shared-validators/src/committeeUtils.ts` | `CommitteeWithMembers` type (should be updated in 3.0) |
| `packages/shared-validators/src/reportTypeMapping.ts` | Mapping table |

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.0a
- [3.0 Report-server Migration](3.0-report-server-committee-membership-migration.md)
- [3.2 Sign-In Sheet Report UI](3.2-sign-in-sheet-report-ui.md)

