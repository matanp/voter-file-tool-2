# 3.0a Audit and Update All Reports for CommitteeMembership

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.0a
**Effort:** 0.5–1 day
**Depends on:** [3.0 Report-server Migration](3.0-report-server-committee-membership-migration.md)

## Summary

Run a report-by-report audit to ensure no report path depends on legacy committee-membership sources after 3.0. Confirm migration status for each report type and capture any required follow-up work.

## Current State — Report Type Inventory

The report-server dispatches 5 report types in `apps/report-server/src/index.ts` `processJob()` (lines ~189–302):

| Report Type | Handler Location | Uses Committee Data? | Expected Status |
|---|---|---|---|
| `ldCommittees` | index.ts:193–212 → `committeeMappingHelpers.ts` | **Yes** — fetches memberships | Migrated in 3.0 |
| `designatedPetition` | index.ts:236–258 → `DesignatingPetition.tsx` | **No** — uses payload candidates/party directly | No migration needed |
| `voterList` | index.ts:213–235 → `xlsxGenerator.ts` | **No** — uses search query → VoterRecord[] | No migration needed |
| `absenteeReport` | index.ts:259–264 → `reportProcessors/absenteeReportProcessor.ts` | **No** — loads CSV from R2, calculates stats | No migration needed |
| `voterImport` | index.ts:265–299 → `reportProcessors/voterImportProcessor.ts` | **No** — streams file from R2, processes voter records | No migration needed |

**Key finding from Roadmap §3.0a:** Only `ldCommittees` uses committee membership data. The other 4 report types do NOT reference committee membership at all.

## Acceptance Criteria

### Per-Report Audit Checklist
- [ ] **`ldCommittees`** — Confirm migrated in 3.0. Verify:
  - `fetchCommitteeData()` uses `memberships` with `status=ACTIVE`
  - `CommitteeReport.tsx` receives correct `LDCommitteesArray` shape
  - `xlsxGenerator.ts` `generateUnifiedXLSXAndUpload()` with `dataType: 'ldCommittees'` works with new shape
  - No `committeeMemberList` references remain
- [ ] **`designatedPetition`** — Confirm no committee membership dependency:
  - `DesignatingPetition.tsx` only uses `payload` prop (candidates, party, appointments)
  - No Prisma queries for committee data in this path
  - Document: "No migration needed — uses request payload only"
- [ ] **`voterList`** — Confirm no committee membership dependency:
  - Handler uses `searchQuery` to fetch VoterRecords directly via Prisma
  - `generateVoterListXLSXAndUpload()` consumes `PartialVoterRecordAPI[]`
  - Document: "No migration needed — direct VoterRecord query"
- [ ] **`absenteeReport`** — Confirm no committee membership dependency:
  - `absenteeReportProcessor.ts` loads CSV from R2 via `AbsenteeDataLoader`
  - No Prisma queries for committee data
  - Document: "No migration needed — CSV-based pipeline"
- [ ] **`voterImport`** — Confirm no committee membership dependency:
  - `voterImportProcessor.ts` streams file from R2 and processes voter records
  - No committee membership queries
  - Document: "No migration needed — voter file processing only"

### Codebase-Wide Verification
- [ ] Run `grep -r "committeeMemberList" apps/report-server/` — confirm zero results.
- [ ] Run `grep -r "committeeMemberList" packages/shared-validators/src/` — confirm zero results (or only in deprecated/removed code).
- [ ] Verify `packages/shared-validators/src/schemas/report.ts` `generateReportSchema` discriminated union has no `committeeMemberList` references.
- [ ] Verify `packages/shared-validators/src/reportTypeMapping.ts` `REPORT_TYPE_MAPPINGS` is clean.

### Test Coverage
- [ ] Confirm `apps/report-server/src/__tests__/committeeMappingHelpers.test.ts` covers the migrated `ldCommittees` path.
- [ ] If any report processor lacks test coverage for its data-fetching path, add a smoke test confirming the absence of committee dependency (e.g., `designatedPetition` handler does not call `prisma.committeeMembership`).

### Audit Record
- [ ] Record final audit outcome in this ticket with pass/fail per report type.
- [ ] If any report needs follow-up changes, create a sub-ticket with the exact file and required update.

## Implementation Steps

1. **Read each handler** — For each of the 5 `processJob()` branches in `index.ts`, trace the data flow to confirm what data sources are used.
2. **Grep for legacy references** — Search report-server and shared-validators for `committeeMemberList`, `committeeMember`, or other legacy patterns.
3. **Document findings** — Fill in the checklist above with pass/fail and notes.
4. **Fix any issues** — If a reference is found, update the code and add a test.
5. **Close ticket** — Record the audit outcome directly in this ticket file.

## Files to Audit

| File | What to Check |
|------|---------------|
| `apps/report-server/src/index.ts` | All 5 handler branches in `processJob()` |
| `apps/report-server/src/committeeMappingHelpers.ts` | `fetchCommitteeData()`, `mapCommitteesToReportShape()`, types |
| `apps/report-server/src/components/CommitteeReport.tsx` | Input types, no direct Prisma calls |
| `apps/report-server/src/components/DesignatingPetition.tsx` | Confirm payload-only, no committee queries |
| `apps/report-server/src/xlsxGenerator.ts` | Both `ldCommittees` and `voterList` paths |
| `apps/report-server/src/reportProcessors/absenteeReportProcessor.ts` | CSV-only pipeline |
| `apps/report-server/src/reportProcessors/voterImportProcessor.ts` | File-processing pipeline |
| `apps/report-server/src/utils.ts` | `transformToCommitteeMemberFormat()` helper |
| `packages/shared-validators/src/schemas/report.ts` | Zod schemas for all report types |
| `packages/shared-validators/src/committeeUtils.ts` | `CommitteeWithMembers` type (should be updated in 3.0) |
| `packages/shared-validators/src/reportTypeMapping.ts` | Mapping table |

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) §3.0a
- [3.0 Report-server Migration](3.0-report-server-committee-membership-migration.md)
- [3.2 Sign-In Sheet Report UI](3.2-sign-in-sheet-report-ui.md)

