# T1.3 Committee Discrepancy Handling Tests

**Status:** Done
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Testing Tier 1 §T1.3
**Effort:** 1–2 days
**Depends on:** Nothing (can run in parallel with Batch A)

## Summary

Add automated tests for the bulk committee load and discrepancy resolution routes. These routes are high-risk (batch data import, member reconciliation) and are currently untested.

## Acceptance Criteria

### `admin/bulkLoadCommittees` Route Tests

- [x] Auth: unauthenticated → 401; non-Admin → 403; Admin → allowed
- [x] Valid import with no discrepancies: loadCommitteeLists returns empty Map → no `CommitteeUploadDiscrepancy` created, 200 OK
- [x] Import with name/address mismatches: discrepancy records created per mismatched voter; import completes
- [x] Import with voter VRCNUM not found in DB: discrepancy created (bulkLoadUtils flags it; route creates CommitteeUploadDiscrepancy)
- [x] Empty load (loadCommitteeLists returns empty Map): 200 OK, no discrepancies
- [x] All discrepancies: import completes, all voters flagged
- [x] VERCEL env: returns error, blocks file load
- [x] loadCommitteeLists throws: 500

### `admin/handleCommitteeDiscrepancy` Route Tests

- [x] Auth: unauthenticated → 401; non-Admin → 403; Admin → allowed
- [x] Accept resolution: voter added via committeeList.update connect; discrepancy deleted
- [x] Reject resolution: voter not added; discrepancy deleted
- [x] Invalid VRCNUM (discrepancy not found): 404
- [x] Already-resolved discrepancy: second call returns 404 (idempotent — discrepancy was deleted)
- [x] Voter not found in DB at accept time: committeeList.update fails → 500
- [x] takeAddress: voterRecord.update when provided

### Edge Cases

- [x] Payload: route has no JSON payload (reads from file) — N/A; VRCNUM required for handleCommitteeDiscrepancy → 400 when missing
- [x] Concurrent resolve: second call gets 404 (discrepancy deleted by first)

## Implementation Notes

- **Files to test:**
  - `apps/frontend/src/app/api/admin/bulkLoadCommittees/route.ts`
  - `apps/frontend/src/app/api/admin/handleCommitteeDiscrepancy/route.ts`
- **Test file locations:**
  - `apps/frontend/src/__tests__/api/admin/bulkLoadCommittees.test.ts`
  - `apps/frontend/src/__tests__/api/admin/handleCommitteeDiscrepancy.test.ts`
- **Pattern:** mock Prisma via `jest.mock`, use existing auth mock helpers
- **Pre-condition:** review both route files before writing tests to understand current behavior — do not assume acceptance criteria above matches implementation exactly; adjust tests to match actual behavior and flag any discrepancies as TODO comments

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Testing Tier 1 §T1.3
- [TEST_REVIEW_GAPS.md](../../CODEBASE_AUDIT/TEST_REVIEW_GAPS.md)
- [T1.1 handleRequest Route Tests](T1.1-handleRequest-route-tests.md) — example of existing route test pattern
- [1.2 CommitteeMembership Model](1.2-committee-membership-model.md) — these routes will be updated in 1.2; tests may need updating after that migration
