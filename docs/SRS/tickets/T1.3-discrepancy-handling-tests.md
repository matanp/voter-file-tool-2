# T1.3 Committee Discrepancy Handling Tests

**Status:** Open
**Roadmap:** [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Testing Tier 1 §T1.3
**Effort:** 1–2 days
**Depends on:** Nothing (can run in parallel with Batch A)

## Summary

Add automated tests for the bulk committee load and discrepancy resolution routes. These routes are high-risk (batch data import, member reconciliation) and are currently untested.

## Acceptance Criteria

### `admin/bulkLoadCommittees` Route Tests

- [ ] Auth: unauthenticated → 401; non-Admin → 403; Admin → allowed
- [ ] Valid import with no discrepancies: all members created/updated, no `CommitteeUploadDiscrepancy` records created
- [ ] Import with name/address mismatches: discrepancy records created per mismatched voter; import otherwise completes
- [ ] Import with voter VRCNUM not found in DB: discrepancy created (or member skipped per current behavior — document expected behavior in test)
- [ ] Empty committee list in payload: no-op, 200 OK
- [ ] All discrepancies: import completes, all voters flagged

### `admin/handleCommitteeDiscrepancy` Route Tests

- [ ] Auth: unauthenticated → 401; non-Admin → 403; Admin → allowed
- [ ] Accept resolution: voter added to committee (or membership created); discrepancy record marked resolved
- [ ] Reject resolution: voter not added; discrepancy record marked resolved
- [ ] Invalid discrepancy ID: 404
- [ ] Already-resolved discrepancy: idempotent — 200 OK or 409 depending on current behavior (document in test)
- [ ] Voter not found in DB at accept time: 404 or structured error

### Edge Cases

- [ ] Payload with no discrepancies array → validate schema (400 if required field missing)
- [ ] Concurrent resolve calls on same discrepancy: verify last-write-wins or idempotency (document behavior)

## Implementation Notes

- **Files to test:**
  - `apps/frontend/src/app/api/admin/bulkLoadCommittees/route.ts`
  - `apps/frontend/src/app/api/admin/handleCommitteeDiscrepancy/route.ts`
- **Test file locations:**
  - `apps/frontend/src/__tests__/api/admin/bulkLoadCommittees.test.ts`
  - `apps/frontend/src/__tests__/api/admin/handleCommitteeDiscrepancy.test.ts`
- **Pattern:** mock Prisma via `jest.mock`, use existing auth mock helpers
- **Pre-condition:** review both route files before writing tests to understand current behavior — do not assume acceptance criteria above matches implementation exactly; adjust tests to match actual behavior and flag any discrepancies as TODO comments

## Related

- [SRS_IMPLEMENTATION_ROADMAP.md](../SRS_IMPLEMENTATION_ROADMAP.md) Testing Tier 1 §T1.3
- [TEST_REVIEW_GAPS.md](../../CODEBASE_AUDIT/TEST_REVIEW_GAPS.md)
- [T1.1 handleRequest Route Tests](T1.1-handleRequest-route-tests.md) — example of existing route test pattern
- [1.2 CommitteeMembership Model](1.2-committee-membership-model.md) — these routes will be updated in 1.2; tests may need updating after that migration
