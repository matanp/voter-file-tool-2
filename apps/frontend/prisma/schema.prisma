// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL") // uses connection pooling
}

enum PrivilegeLevel {
  Developer
  Admin
  Leader      // SRS §3.2 — jurisdiction-scoped committee leaders
  RequestAccess
  ReadAccess
}

enum MembershipStatus {
  SUBMITTED       // Leader/admin submitted candidate; awaiting confirmation
  REJECTED        // Executive Committee rejected — terminal state
  CONFIRMED       // Executive Committee confirmed at a meeting
  ACTIVE          // Fully active committee member
  RESIGNED        // Voluntarily resigned (date + method recorded)
  REMOVED         // Administratively removed (reason recorded)
  PETITIONED_WON  // Won a primary election
  PETITIONED_LOST // Lost a primary election
  PETITIONED_TIE  // Tied in primary (seat vacant)
}

enum MembershipType {
  PETITIONED // Gained seat through petition/primary process
  APPOINTED  // Filled a vacancy via Executive Committee vote
}

enum MeetingType {
  EXECUTIVE_COMMITTEE
  OTHER
}

enum RemovalReason {
  PARTY_CHANGE
  MOVED_OUT_OF_DISTRICT
  INACTIVE_REGISTRATION
  DECEASED
  OTHER
}

enum ResignationMethod {
  EMAIL
  MAIL
}

enum AuditAction {
  MEMBER_SUBMITTED
  MEMBER_REJECTED
  MEMBER_CONFIRMED
  MEMBER_ACTIVATED
  MEMBER_RESIGNED
  MEMBER_REMOVED
  PETITION_RECORDED
  MEETING_CREATED
  REPORT_GENERATED
  TERM_CREATED
  JURISDICTION_ASSIGNED
  JURISDICTION_REMOVED
  DISCREPANCY_RESOLVED
}

model User {
  id             String          @id @default(cuid())
  name           String?
  email          String          @unique
  emailVerified  DateTime?
  image          String?
  privilegeLevel PrivilegeLevel  @default(ReadAccess)
  accounts       Account[]
  sessions       Session[]
  // Optional for WebAuthn support
  Authenticator  Authenticator[]

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  Report               Report[]

  // SRS 1.2 — CommitteeMembership relations
  submittedMemberships CommitteeMembership[]  @relation("SubmittedMemberships")

  // SRS 2.4 — Meeting records created by this user
  createdMeetings      MeetingRecord[]        @relation("CreatedMeetings")

  // SRS 1.5 — Audit trail
  auditLogs            AuditLog[]             @relation("AuditLogs")
  reviewedEligibilityFlags EligibilityFlag[]  @relation("EligibilityFlagsReviewed")

  // SRS 3.1 — Jurisdiction assignments (Leader access scope)
  jurisdictions        UserJurisdiction[]     @relation("UserJurisdictions")
  assignedJurisdictions UserJurisdiction[]     @relation("AssignedJurisdictions")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model PrivilegedUser {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  privilegeLevel PrivilegeLevel
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Invite {
  id             String         @id @default(cuid())
  email          String
  token          String         @unique
  privilegeLevel PrivilegeLevel
  customMessage  String?
  expiresAt      DateTime
  usedAt         DateTime?
  createdBy      String
  createdAt      DateTime       @default(now())
  deleted        Boolean        @default(false)
  deletedAt      DateTime?
}

// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

model VoterRecordArchive {
  id                    Int       @id @default(autoincrement())
  VRCNUM                String
  recordEntryYear       Int
  recordEntryNumber     Int
  lastName              String?
  firstName             String?
  middleInitial         String?
  suffixName            String?
  houseNum              Int?
  street                String?
  apartment             String?
  halfAddress           String?
  resAddrLine2          String?
  resAddrLine3          String?
  city                  String?
  state                 String?
  zipCode               String?
  zipSuffix             String?
  telephone             String?
  email                 String?
  mailingAddress1       String?
  mailingAddress2       String?
  mailingAddress3       String?
  mailingAddress4       String?
  mailingCity           String?
  mailingState          String?
  mailingZip            String?
  mailingZipSuffix      String?
  party                 String?
  gender                String?
  DOB                   DateTime?
  L_T                   String?
  electionDistrict      Int?
  countyLegDistrict     String?
  stateAssmblyDistrict  String?
  stateSenateDistrict   String?
  congressionalDistrict String?
  CC_WD_Village         String?
  townCode              String?
  lastUpdate            DateTime?
  originalRegDate       DateTime?
  statevid              String?

  @@unique([VRCNUM, recordEntryYear, recordEntryNumber])
}

model VoterRecord {
  VRCNUM                     String                @id
  votingRecords              VotingHistoryRecord[]
  committee                  CommitteeList?        @relation(fields: [committeeId], references: [id], onDelete: SetNull)
  committeeId                Int?  // DEPRECATED (SRS 1.2): replaced by CommitteeMembership; removal deferred to ticket 3.0
  addressForCommittee        String?
  latestRecordEntryYear      Int
  latestRecordEntryNumber    Int
  lastName                   String?
  firstName                  String?
  middleInitial              String?
  suffixName                 String?
  houseNum                   Int?
  street                     String?
  apartment                  String?
  halfAddress                String?
  resAddrLine2               String?
  resAddrLine3               String?
  city                       String?
  state                      String?
  zipCode                    String?
  zipSuffix                  String?
  telephone                  String?
  email                      String?
  mailingAddress1            String?
  mailingAddress2            String?
  mailingAddress3            String?
  mailingAddress4            String?
  mailingCity                String?
  mailingState               String?
  mailingZip                 String?
  mailingZipSuffix           String?
  party                      String?
  gender                     String?
  DOB                        DateTime?
  L_T                        String?
  electionDistrict           Int?
  countyLegDistrict          String?
  stateAssmblyDistrict       String?
  stateSenateDistrict        String?
  congressionalDistrict      String?
  CC_WD_Village              String?
  townCode                   String?
  lastUpdate                 DateTime?
  originalRegDate            DateTime?
  statevid                   String?
  hasDiscrepancy             Boolean?
  addToCommitteeRequest      CommitteeRequest[]    @relation(name: "addToCommitteeRequest")
  removeFromCommitteeRequest CommitteeRequest[]    @relation(name: "removeFromCommitteeRequest")

  // SRS 1.2 — CommitteeMembership (replaces committeeId FK in ticket 3.0)
  memberships                CommitteeMembership[]
}

model VotingHistoryRecord {
  id            Int         @id @default(autoincrement())
  voterRecord   VoterRecord @relation(fields: [voterRecordId], references: [VRCNUM], onDelete: Cascade)
  voterRecordId String
  date          DateTime
  value         String
}

model CommitteeTerm {
  id        String   @id @default(cuid())
  label     String   @unique // e.g. "2024–2026"
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false) // Only one term active at a time
  createdAt DateTime @default(now())

  committeeLists   CommitteeList[]
  memberships      CommitteeMembership[]
  seats            Seat[]
  userJurisdictions UserJurisdiction[]
}

// SRS 3.1 — Leader jurisdiction scope (cityTown + optional legDistrict per term).
// legDistrict null = all leg districts in cityTown.
// NOTE: A partial unique index (WHERE legDistrict IS NULL) exists in
// prisma/migrations/20260221120000_user_jurisdiction_partial_unique_legdistrict_null/migration.sql
// but is not reflected here — Prisma does not support partial indexes.
model UserJurisdiction {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation("UserJurisdictions", fields: [userId], references: [id], onDelete: Cascade)
  cityTown    String
  legDistrict Int?          // null = all leg districts in cityTown
  termId      String
  term        CommitteeTerm @relation(fields: [termId], references: [id], onDelete: Restrict)
  createdAt   DateTime      @default(now())
  createdById String
  createdBy   User          @relation("AssignedJurisdictions", fields: [createdById], references: [id], onDelete: Restrict)

  @@unique([userId, cityTown, legDistrict, termId])
  @@index([userId, termId])
  @@index([termId])
  @@index([createdById])
}

model CommitteeList {
  id                          Int                          @id @default(autoincrement())
  cityTown                    String
  legDistrict                 Int
  electionDistrict            Int
  termId                      String
  term                        CommitteeTerm                @relation(fields: [termId], references: [id], onDelete: Restrict)
  ltedWeight                  Decimal?                     // SRS §8.1 — LTED total weight; seat weight = ltedWeight / maxSeatsPerLted
  committeeMemberList         VoterRecord[]                // deprecated — see ticket 3.0
  CommitteeRequest            CommitteeRequest[]
  CommitteeDiscrepancyRecords CommitteeUploadDiscrepancy[]
  memberships                 CommitteeMembership[]
  seats                       Seat[]

  @@unique([cityTown, legDistrict, electionDistrict, termId])
}

// SRS 1.4 — Explicit seat model for weight tracking (§8.1, §8.2)
model Seat {
  id              String        @id @default(cuid())
  committeeList   CommitteeList @relation(fields: [committeeListId], references: [id])
  committeeListId Int
  term            CommitteeTerm @relation(fields: [termId], references: [id])
  termId          String
  seatNumber      Int           // 1–maxSeatsPerLted
  isPetitioned    Boolean       @default(false) // Immutable for term; set by petition workflow (future)
  weight          Decimal?     // ltedWeight / maxSeatsPerLted — null until LTED weight known

  @@unique([committeeListId, termId, seatNumber])
  @@index([committeeListId, termId])
}

// SRS 2.4 — Meeting record for bulk confirmation/rejection workflow
model MeetingRecord {
  id          String        @id @default(cuid())
  meetingDate DateTime
  meetingType MeetingType   @default(EXECUTIVE_COMMITTEE)
  notes       String?
  createdById String
  createdBy   User          @relation("CreatedMeetings", fields: [createdById], references: [id])
  createdAt   DateTime      @default(now())
  memberships CommitteeMembership[]
}

model CommitteeRequest {
  id                  Int           @id @default(autoincrement())
  committeList        CommitteeList @relation(fields: [committeeListId], references: [id], onDelete: Cascade)
  committeeListId     Int
  addVoterRecord      VoterRecord?  @relation(name: "addToCommitteeRequest", fields: [addVoterRecordId], references: [VRCNUM], onDelete: Cascade)
  addVoterRecordId    String?
  removeVoterRecord   VoterRecord?  @relation(name: "removeFromCommitteeRequest", fields: [removeVoterRecordId], references: [VRCNUM], onDelete: Cascade)
  removeVoterRecordId String?
  requestNotes        String?
}

// ============================================================================
// SRS §6 — Authoritative record of a voter's relationship to a committee.
// Replaces VoterRecord.committeeId (deferred removal to ticket 3.0).
// Never deleted — status transitions only.
// ============================================================================
model CommitteeMembership {
  id              String           @id @default(cuid())

  voterRecord     VoterRecord      @relation(fields: [voterRecordId], references: [VRCNUM])
  voterRecordId   String
  committeeList   CommitteeList    @relation(fields: [committeeListId], references: [id])
  committeeListId Int
  term            CommitteeTerm    @relation(fields: [termId], references: [id])
  termId          String

  status          MembershipStatus @default(SUBMITTED)
  membershipType  MembershipType?
  seatNumber      Int?

  submittedAt     DateTime         @default(now())
  confirmedAt     DateTime?
  activatedAt     DateTime?
  resignedAt      DateTime?
  removedAt       DateTime?
  rejectedAt      DateTime?
  rejectionNote   String?

  submittedById   String?
  submittedBy     User?            @relation("SubmittedMemberships", fields: [submittedById], references: [id])
  // submissionMetadata.removeMemberId stores the intended replacement target for leader requests
  submissionMetadata Json?

  meetingRecord   MeetingRecord? @relation(fields: [meetingRecordId], references: [id])
  meetingRecordId String?

  resignationDateReceived DateTime?
  resignationMethod       ResignationMethod?

  removalReason   RemovalReason?
  removalNotes    String?

  petitionVoteCount   Int?
  petitionPrimaryDate DateTime?
  // SRS 2.6 — ties candidate/outcome to a specific seat for petition workflow
  petitionSeatNumber  Int?
  eligibilityFlags    EligibilityFlag[]

  @@unique([voterRecordId, committeeListId, termId])
  @@index([committeeListId, termId, status])
  @@index([termId, status])
  @@index([voterRecordId])
  @@index([committeeListId, termId, petitionSeatNumber])
}

model EligibilityFlag {
  id              String                @id @default(cuid())
  membershipId    String
  membership      CommitteeMembership   @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  committeeListId Int
  voterRecordId   String
  termId          String
  reason          EligibilityFlagReason
  status          EligibilityFlagStatus @default(PENDING)
  details         Json?
  sourceReportId  String?
  reviewedById    String?
  reviewedBy      User?                 @relation("EligibilityFlagsReviewed", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([status, createdAt])
  @@index([committeeListId, termId])
  @@index([membershipId, reason, status])
}

// ============================================================================
// SRS §1.5 — Immutable audit trail for all system changes.
// Write-once: no update or delete operations permitted.
// ============================================================================
model AuditLog {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation("AuditLogs", fields: [userId], references: [id])
  userRole    PrivilegeLevel
  action      AuditAction
  entityType  String         // e.g. "CommitteeMembership", "MeetingRecord"
  entityId    String         // ID of the affected record
  timestamp   DateTime       @default(now())
  beforeValue Json?          // Snapshot before change
  afterValue  Json?          // Snapshot after change
  metadata    Json?          // Additional context (override reason, bypass notes, etc.)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@index([action])
}

model DropdownLists {
  id                    Int      @id @default(autoincrement())
  city                  String[]
  zipCode               String[]
  street                String[]
  countyLegDistrict     String[]
  stateAssmblyDistrict  String[]
  stateSenateDistrict   String[]
  congressionalDistrict String[]
  townCode              String[]
  electionDistrict      String[]
  party                 String[]
}

model CommitteeUploadDiscrepancy {
  id          String        @id @default(cuid())
  VRCNUM      String        @unique
  committee   CommitteeList @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  committeeId Int
  discrepancy Json
}

model ElectionDate {
  id   Int      @id @default(autoincrement())
  date DateTime @unique
}

model OfficeName {
  id         Int    @id @default(autoincrement())
  officeName String @unique
}

model Report {
  id            String     @id @default(cuid())
  generatedById String
  generatedBy   User       @relation(fields: [generatedById], references: [id])
  ReportType    ReportType
  fileKey       String?
  title         String?
  description   String?
  fileType      String?
  public        Boolean    @default(false)
  status        JobStatus  @default(PENDING)
  requestedAt   DateTime   @default(now())
  completedAt   DateTime?
  deleted       Boolean    @default(false)
  metadata      Json?      // Store report-specific metadata (voter import stats, etc.)

  @@index([generatedById])
  @@index([status])
  @@index([public])
  @@index([requestedAt])
  @@index([generatedById, status])
  @@index([public, status])
}

enum ReportType {
  CommitteeReport
  DesignatedPetition
  VoterList
  AbsenteeReport
  VoterImport
  SignInSheet
}


enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum IneligibilityReason {
  NOT_REGISTERED
  PARTY_MISMATCH
  ASSEMBLY_DISTRICT_MISMATCH
  CAPACITY
  ALREADY_IN_ANOTHER_COMMITTEE
}

enum EligibilityFlagReason {
  PARTY_MISMATCH
  ASSEMBLY_DISTRICT_MISMATCH
  VOTER_NOT_FOUND
  POSSIBLY_INACTIVE
}

enum EligibilityFlagStatus {
  PENDING
  CONFIRMED
  DISMISSED
}

model CommitteeGovernanceConfig {
  id                                 String              @id @default(cuid())
  requiredPartyCode                  String
  maxSeatsPerLted                    Int                 @default(4)
  requireAssemblyDistrictMatch       Boolean             @default(true)
  nonOverridableIneligibilityReasons IneligibilityReason[] @default([])
  updatedAt                          DateTime            @updatedAt
}

// SRS §4.2 — LTED-to-district crosswalk. Maps (cityTown, legDistrict, electionDistrict) to Assembly,
// Senate, Congressional, and local districts. Used for eligibility validation (§7.1) when requireAssemblyDistrictMatch.
// Populated from MCDC-provided data (format TBD; empty table acceptable until Gaps §2.1 resolved).
model LtedDistrictCrosswalk {
  id                    String  @id @default(cuid())
  cityTown              String
  legDistrict           Int
  electionDistrict      Int
  stateAssemblyDistrict String
  stateSenateDistrict   String?
  congressionalDistrict String?
  countyLegDistrict     String?

  @@unique([cityTown, legDistrict, electionDistrict])
}
